<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Limpieza Mensual</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            touch-action: pan-y;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #f8f9fa;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: #00b4db;
            color: white;
        }

        .btn-primary:hover {
            background: #0083b0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,180,219,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            padding: 30px;
            background: #f8f9fa;
        }

        .calendar-day {
            background: white;
            border-radius: 10px;
            padding: 15px;
            min-height: 160px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
            cursor: grab;
        }

        .calendar-day.dragging {
            opacity: 0.7;
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            cursor: grabbing;
        }

        .calendar-day.day-drop-zone {
            border: 3px dashed #28a745;
            background: #f0fff4;
        }

        .download-mode .day-actions,
        .download-mode .person-count,
        .download-mode .notes-section,
        .download-mode .controls,
        .download-mode .file-upload-section,
        .download-mode #statusMessage {
            display: none !important;
        }

        .calendar-day.hidden {
            opacity: 0.5;
            background-color: #f0f0f0;
        }

        .calendar-day.drag-over {
            border: 3px dashed #00b4db;
            background: #e3f2fd;
        }

        .calendar-day.sunday {
            background: #ffeaea;
        }

        .calendar-day.empty {
            background: #f8f9fa;
            opacity: 0.7;
        }

        .day-header {
            font-size: 16px;
            font-weight: bold;
            color: #00b4db;
            margin-bottom: 10px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .sunday .day-header {
            color: #d63031;
        }

        .day-content {
            font-size: 15px;
            color: #333;
            line-height: 1.4;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .no-activity {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            color: #6c757d;
            padding: 10px;
        }

        .person-item {
            padding: 6px 8px;
            margin: 3px 0;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .person-item:hover {
            background: #e9ecef;
            transform: scale(1.02);
        }

        .person-item.dragging {
            opacity: 0.5;
            background: #cce7ff !important;
            transform: scale(1.05);
            z-index: 1000;
        }

        .person-item.drag-over {
            background: #e3f2fd;
            border: 2px dashed #00b4db;
        }

        .person-item.selected {
            background: #cce7ff;
            border: 2px solid #007bff;
            transform: scale(1.05);
        }

        .person-item.position-indicator {
            background: #e3f2fd;
            border: 2px dashed #00b4db;
            color: #00b4db;
            font-weight: bold;
            text-align: center;
        }

        .delete-person-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .person-item.selected .delete-person-btn {
            display: flex;
        }

        .delete-person-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .person-name {
            flex-grow: 1;
        }

        .group-header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 8px;
            margin-top: 15px;
        }

        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .login-modal.active {
            display: flex;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            max-width: 350px;
            width: 90%;
        }

        .login-box h2 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            font-size: 1.6em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: bold;
            font-size: 16px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00b4db;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info span {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .file-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-input-container input[type="file"] {
            display: none;
        }

        .file-input-label {
            padding: 10px 14px;
            background: #6c757d;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s;
        }

        .drag-info {
            text-align: center;
            padding: 8px;
            color: #6c757d;
            font-style: italic;
            grid-column: 1 / -1;
            font-size: 15px;
        }

        .status-message {
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
            text-align: center;
            font-size: 15px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .date-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .file-upload-section {
            background: #e9f7fe;
            padding: 12px 15px;
            margin: 15px 25px;
            border-radius: 8px;
            border-left: 4px solid #00b4db;
        }

        .day-actions {
            position: absolute;
            bottom: 6px;
            right: 6px;
            display: flex;
            gap: 4px;
        }

        .position-controls {
            position: absolute;
            top: 6px;
            left: 6px;
            display: flex;
            gap: 2px;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .calendar-day.show-position-controls .position-controls {
            opacity: 1;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .position-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: #6c757d;
            color: white;
        }

        .position-btn:hover {
            transform: scale(1.1);
        }

        .position-btn.up {
            background: #28a745;
        }

        .position-btn.down {
            background: #007bff;
        }

        .add-btn {
            background: #28a745;
            color: white;
        }

        .add-btn:hover {
            background: #218838;
            transform: scale(1.1);
        }

        .clear-btn {
            background: #dc3545;
            color: white;
        }

        .clear-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .remove-btn {
            background: #ffc107;
            color: #212529;
        }

        .remove-btn:hover {
            background: #e0a800;
            transform: scale(1.1);
        }

        .toggle-btn {
            background: #6c757d;
            color: white;
        }

        .toggle-btn:hover {
            background: #5a6268;
            transform: scale(1.1);
        }

        .custom-add-btn {
            background: #17a2b8 !important;
            color: white;
        }

        .custom-add-btn:hover {
            background: #138496 !important;
            transform: scale(1.1);
        }

        .person-count {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .time-label {
            font-size: 10px;
            color: #dc3545;
            font-weight: bold;
            text-align: center;
            padding: 2px 4px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 2px;
            margin: 2px 0;
        }

        .person-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: 5px;
            position: relative;
        }

        .font-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .font-btn {
            width: 38px;
            height: 38px;
            border: none;
            border-radius: 4px;
            background: #6c757d;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .font-select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .font-xs .person-item { font-size: 10px; padding: 3px 5px; }
        .font-sm .person-item { font-size: 12px; padding: 4px 6px; }
        .font-md .person-item { font-size: 14px; padding: 5px 7px; }
        .font-lg .person-item { font-size: 16px; padding: 6px 8px; }
        .font-xl .person-item { font-size: 18px; padding: 7px 9px; }

        .font-xs .day-header { font-size: 13px; }
        .font-sm .day-header { font-size: 14px; }
        .font-md .day-header { font-size: 16px; }
        .font-lg .day-header { font-size: 18px; }
        .font-xl .day-header { font-size: 20px; }

        /* Nuevos estilos para el sistema de drag & drop mejorado */
        .drop-indicator {
            height: 3px;
            background: #28a745;
            margin: 2px 0;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .drop-indicator.visible {
            opacity: 1;
        }
        
        .drop-indicator.top {
            margin-top: 0;
        }
        
        .drop-indicator.bottom {
            margin-bottom: 0;
        }
        
        .calendar-day.drop-zone {
            border: 2px dashed #28a745;
            background: #f8fff8;
        }
        
        .person-list.drop-zone {
            min-height: 20px;
            border: 1px dashed #007bff;
            background: #f0f8ff;
        }

        /* Estilos para el modal de selecci칩n de personas */
        .person-select-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .person-select-modal.active {
            display: flex;
        }

        .person-select-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .person-select-box h2 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            font-size: 1.6em;
        }

        .person-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .person-option {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .person-option:hover {
            background: #e9ecef;
            transform: scale(1.02);
        }

        .person-option.selected {
            background: #cce7ff;
            border-color: #007bff;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #00b4db;
        }

        /* Estilos para el sistema t치ctil */
        .person-item.touch-dragging {
            position: fixed;
            z-index: 10000;
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            background: #cce7ff !important;
            opacity: 0.9;
            pointer-events: none;
        }

        .calendar-day.drop-target {
            border: 3px solid #28a745;
            background: #f0fff4;
            transform: scale(1.02);
        }

        .calendar-day.day-move-source {
            border: 3px solid #ffc107;
            background: #fffbf0;
            transform: scale(1.02);
        }

        .calendar-day.day-move-target {
            border: 3px solid #28a745;
            background: #f0fff4;
            transform: scale(1.02);
        }

        .mobile-menu {
            position: fixed;
            background: white;
            border: 2px solid #00b4db;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            min-width: 180px;
        }

        .mobile-menu-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 2px 0;
            border: none;
                    border-radius: 4px;
            background: #00b4db;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .mobile-menu-btn:hover {
            background: #0083b0;
        }

        .mobile-menu-btn.cancel {
            background: #6c757d;
        }

        .mobile-menu-btn.cancel:hover {
            background: #5a6268;
        }

        .drag-ghost {
            position: fixed;
            background: #cce7ff;
            border: 2px dashed #00b4db;
            border-radius: 4px;
            padding: 8px;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.8;
            transform: translate(-50%, -50%);
        }

        /* Indicadores de desplazamiento */
        .scroll-indicator {
            position: fixed;
            width: 100%;
            height: 60px;
            background: linear-gradient(to bottom, rgba(0,180,219,0.7), transparent);
            z-index: 9998;
            display: none;
            pointer-events: none;
        }

        .scroll-indicator.top {
            top: 0;
            background: linear-gradient(to bottom, rgba(0,180,219,0.7), transparent);
        }

        .scroll-indicator.bottom {
            bottom: 0;
            background: linear-gradient(to top, rgba(0,180,219,0.7), transparent);
        }

        .scroll-indicator.active {
            display: block;
        }

        @media (max-width: 1200px) {
            .calendar-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
                padding: 15px;
                gap: 6px;
            }

            .header h1 {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .calendar-day {
                min-height: 150px;
                padding: 12px;
            }

            .person-item {
                padding: 8px;
                font-size: 13px;
                touch-action: none;
            }

            .day-actions {
                position: relative;
                bottom: auto;
                right: auto;
                justify-content: center;
                margin-top: 8px;
            }

            .position-controls {
                position: relative;
                top: auto;
                left: auto;
                flex-direction: row;
                justify-content: center;
                margin-bottom: 5px;
                opacity: 1;
            }

            .action-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .position-btn {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }

            /* En m칩viles, las flechas siempre visibles */
            .calendar-day .position-controls {
                opacity: 1 !important;
            }

            .delete-person-btn {
                width: 20px;
                height: 20px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }

            body {
                padding: 8px;
            }
        }

        /* Detectar si es dispositivo t치ctil */
        @media (hover: none) and (pointer: coarse) {
            .person-item {
                cursor: default;
            }
            
            .calendar-day .position-controls {
                opacity: 1 !important;
            }
        }
    </style>
</head>
<body>
    <!-- Indicadores de desplazamiento -->
    <div class="scroll-indicator top" id="scrollTopIndicator"></div>
    <div class="scroll-indicator bottom" id="scrollBottomIndicator"></div>

    <div class="container">
        <div class="header">
            <h1>游늰 CRONOGRAMA DE LIMPIEZA MENSUAL</h1>
            <p id="currentMonthYear">Cargando...</p>
        </div>

        <div class="controls">
            <div class="date-controls">
                <label>Fecha inicio (Lunes):</label>
                <input type="date" id="startDate" value="2025-11-03">
                <button class="btn btn-primary" id="applyDateBtn">Aplicar Fecha</button>
            </div>

            <div class="user-info" id="userInfo">
                <button class="btn btn-primary" id="loginBtn">游댏 Iniciar Sesi칩n</button>
            </div>

            <div class="font-controls">
                <select class="font-select" id="fontFamilySelect">
                    <option value="Arial">Arial</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                </select>
                <button class="font-btn" id="fontDecreaseBtn" title="Disminuir fuente">A-</button>
                <button class="font-btn" id="fontIncreaseBtn" title="Aumentar fuente">A+</button>
            </div>

            <div>
                <button class="btn btn-success" id="downloadBtn">游닌 Descargar Imagen</button>
                <button class="btn btn-primary" id="updateExcelBtn">游 Actualizar Excel</button>
            </div>
        </div>

        <div id="statusMessage"></div>

        <div class="file-upload-section" id="fileUploadSection" style="display: none;">
            <h3>游늬 Cargar Archivo Excel</h3>
            <p>No se encontr칩 el archivo "Limpieza_igle.xlsx" en la misma carpeta. Por favor, cargue el archivo manualmente:</p>
            <div class="file-input-container">
                <input type="file" id="excelFile" accept=".xlsx, .xls">
                <label for="excelFile" class="file-input-label">Seleccionar Archivo Excel</label>
                <button class="btn btn-primary" id="loadExcelBtn">Cargar</button>
            </div>
        </div>

        <div id="calendarGrid" class="calendar-grid">
            <div class="drag-info" id="dragInfo">
                拘勇 Buscando archivo Excel en la misma carpeta...
            </div>
        </div>
    </div>

    <!-- MODAL DE LOGIN -->
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <h2>Iniciar Sesi칩n</h2>
            <div class="form-group">
                <label>Usuario:</label>
                <input type="text" id="username" placeholder="Ingrese su usuario">
            </div>
            <div class="form-group">
                <label>Contrase침a:</label>
                <input type="password" id="password" placeholder="Ingrese su contrase침a">
            </div>
            <button class="btn btn-primary" style="width: 100%;" id="loginSubmit">Ingresar</button>
            <button class="btn btn-danger" style="width: 100%; margin-top: 8px;" id="loginCancel">Cancelar</button>
        </div>
    </div>

    <!-- NUEVO MODAL PARA SELECCIONAR PERSONA -->
    <div class="person-select-modal" id="personSelectModal">
        <div class="person-select-box">
            <h2>Seleccionar Persona</h2>
            <div class="search-box">
                <input type="text" id="personSearch" placeholder="Buscar persona...">
            </div>
            <div class="person-list-container" id="personListContainer">
                <!-- Las opciones de personas se cargar치n aqu칤 -->
            </div>
            <button class="btn btn-primary" id="confirmPersonBtn" style="width: 100%;">Agregar Persona Seleccionada</button>
            <button class="btn btn-danger" id="cancelPersonBtn" style="width: 100%; margin-top: 10px;">Cancelar</button>
        </div>
    </div>

    <script>
        // Variables globales
        let persons = [];
        let isLoggedIn = false;
        let currentUser = null;
        let currentExcelData = null;
        let originalExcelStructure = null;
        let currentExcelFile = null;
        
        const EXCEL_FILENAME = 'Limpieza_igle.xlsx';
        
        // Credenciales de usuario (se cargar치n desde Excel)
        let VALID_USERS = {};

        let supervisorNames = {
            '1': '', '2': '', '3': '', '4': ''
        };
        let currentFontSize = 'md';
        let currentFontFamily = 'Arial';
        
        let scheduleData = {
            groups: [
                { name: 'Supervisoras grupo #1', color: '#ff6b9d', days: [] },
                { name: 'Supervisoras grupo #2', color: '#4ecdc4', days: [] },
                { name: 'Supervisoras grupo #3', color: '#95e1d3', days: [] },
                { name: 'Supervisoras grupo #4', color: '#ffd166', days: [] }
            ],
            startDate: null
        };

        // Variables para el sistema
        let selectedPerson = null;
        let isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // Variables para el sistema de drag & drop mejorado
        let dragState = {
            isDragging: false,
            draggedElement: null,
            sourceGroupIdx: null,
            sourceDayIdx: null,
            sourcePersonIdx: null
        };

        // Variables para el modal de selecci칩n de personas
        let currentDayForPersonAdd = null;

        // Variables para el drag & drop de d칤as completos
        let dayDragState = {
            isDragging: false,
            draggedDay: null,
            sourceGroupIdx: null,
            sourceDayIdx: null
        };

        // Variables para el sistema t치ctil
        let touchStartTime = 0;
        let touchStartElement = null;
        let touchDragTimeout = null;
        let isTouchDragging = false;
        let scrollInterval = null;
        let autoScrollSpeed = 10;

        // Funci칩n para verificar si un d칤a tiene solo nombres "Vacio"
        function hasOnlyVacioNames(dayData) {
            return dayData.people.length > 0 && 
                   dayData.people.every(person => 
                       person.toLowerCase().includes('vacio') || 
                       person.trim() === 'Vacio'
                   );
        }

        // Funci칩n para ocultar autom치ticamente d칤as con solo "Vacio"
        function autoHideVacioDays() {
            if (!isLoggedIn) return;
            
            let hiddenCount = 0;
            scheduleData.groups.forEach(group => {
                group.days.forEach(day => {
                    if (hasOnlyVacioNames(day) && !day.hidden) {
                        day.hidden = true;
                        hiddenCount++;
                    }
                });
            });
            
            if (hiddenCount > 0) {
                initSchedule();
                showStatus(`${hiddenCount} d칤as con "Vacio" ocultados autom치ticamente`);
            }
        }

        // Funci칩n para procesar usuarios desde Excel
        function processUsersFromExcel(workbook) {
            VALID_USERS = {};
            
            const userSheetName = workbook.SheetNames.find(name => 
                name.toLowerCase() === 'usuario'
            );

            if (userSheetName) {
                const sheet = workbook.Sheets[userSheetName];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (data.length > 0) {
                    for (let i = 0; i < data.length; i++) {
                        const row = data[i];
                        if (row && row[0]) {
                            const userData = row[0].toString().trim();
                            const parts = userData.split(/\s+/);
                            
                            if (parts.length >= 2) {
                                const username = parts[0].trim();
                                const password = parts[1].trim();
                                
                                if (username && password) {
                                    VALID_USERS[username] = password;
                                }
                            } else if (parts.length === 1) {
                                const username = parts[0].trim();
                                if (username) {
                                    VALID_USERS[username] = "k123k";
                                }
                            }
                        }
                    }
                }
            }
        }

        // Cargar Excel autom치ticamente
        async function loadExcelAutomatically() {
            try {
                showStatus('Buscando archivo Excel...');
                
                const dragInfo = document.getElementById('dragInfo');
                dragInfo.textContent = 'Buscando ' + EXCEL_FILENAME + '...';
                
                try {
                    const response = await fetch(EXCEL_FILENAME);
                    
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        currentExcelData = workbook;
                        currentExcelFile = EXCEL_FILENAME;
                        
                        originalExcelStructure = {};
                        workbook.SheetNames.forEach(sheetName => {
                            originalExcelStructure[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                        });
                        
                        processUsersFromExcel(workbook);
                        processExcelData(workbook);
                        showStatus('Base de datos cargada correctamente desde ' + EXCEL_FILENAME);
                        return;
                    }
                } catch (error) {
                    console.log('No se pudo cargar desde servidor local:', error);
                }
                
                try {
                    const githubUrl = window.location.origin + '/' + EXCEL_FILENAME;
                    const response = await fetch(githubUrl);
                    
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        currentExcelData = workbook;
                        currentExcelFile = EXCEL_FILENAME;
                        
                        originalExcelStructure = {};
                        workbook.SheetNames.forEach(sheetName => {
                            originalExcelStructure[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                        });
                        
                        processUsersFromExcel(workbook);
                        processExcelData(workbook);
                        showStatus('Base de datos cargada correctamente desde GitHub');
                        return;
                    }
                } catch (error) {
                    console.log('No se pudo cargar desde GitHub:', error);
                }
                
                dragInfo.textContent = 'No se encontr칩 ' + EXCEL_FILENAME + ' autom치ticamente. Use el bot칩n de carga manual.';
                document.getElementById('fileUploadSection').style.display = 'block';
                
            } catch (error) {
                console.log('Error en carga autom치tica:', error);
                const dragInfo = document.getElementById('dragInfo');
                dragInfo.textContent = 'Error al buscar ' + EXCEL_FILENAME + '. Use el bot칩n de carga manual.';
                document.getElementById('fileUploadSection').style.display = 'block';
            }
        }

        // Cargar Excel manualmente
        function loadExcelManually(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        currentExcelData = workbook;
                        currentExcelFile = file.name;
                        
                        originalExcelStructure = {};
                        workbook.SheetNames.forEach(sheetName => {
                            originalExcelStructure[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                        });
                        
                        processUsersFromExcel(workbook);
                        processExcelData(workbook);
                        showStatus('Archivo Excel cargado correctamente');
                        document.getElementById('fileUploadSection').style.display = 'none';
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Error al leer el archivo'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // Mostrar mensaje de estado
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 4000);
        }

        // Aplicar tama침o de fuente y familia
        function applyFontStyles() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.className = `calendar-grid font-${currentFontSize}`;
            calendarGrid.style.fontFamily = currentFontFamily;
            
            document.querySelectorAll('.person-item, .day-header').forEach(el => {
                el.style.fontFamily = currentFontFamily;
            });
        }

        // Procesar nombres de supervisoras
        function processSupervisorNames() {
            supervisorNames = {'1': '', '2': '', '3': '', '4': ''};
            
            if (persons.length > 0) {
                persons.forEach(person => {
                    if (person.supervisor && person.supervisor.trim() !== '') {
                        const supervisorNum = person.supervisor.trim();
                        if (supervisorNames.hasOwnProperty(supervisorNum)) {
                            if (supervisorNames[supervisorNum] === '') {
                                supervisorNames[supervisorNum] = person.name;
                            } else {
                                supervisorNames[supervisorNum] += ' - ' + person.name;
                            }
                        }
                    }
                });
            }
            
            scheduleData.groups[0].name = `Supervisoras grupo #1 ${supervisorNames['1'] || ''}`;
            scheduleData.groups[1].name = `Supervisoras grupo #2 ${supervisorNames['2'] || ''}`;
            scheduleData.groups[2].name = `Supervisoras grupo #3 ${supervisorNames['3'] || ''}`;
            scheduleData.groups[3].name = `Supervisoras grupo #4 ${supervisorNames['4'] || ''}`;
        }

        // Procesar datos del Excel
        function processExcelData(workbook) {
            try {
                const scheduleSheetName = workbook.SheetNames.find(name => 
                    name.toLowerCase().includes('cronograma') || 
                    name.toLowerCase().includes('limpieza') ||
                    name.toLowerCase().includes('personas')
                ) || workbook.SheetNames[0];

                if (scheduleSheetName) {
                    const scheduleSheet = workbook.Sheets[scheduleSheetName];
                    const scheduleDataRaw = XLSX.utils.sheet_to_json(scheduleSheet, { header: 1 });
                    
                    persons = [];
                    
                    let nameCol = -1;
                    let supervisorCol = -1;
                    let statusCol = -1;
                    
                    if (scheduleDataRaw.length > 0) {
                        const headerRow = scheduleDataRaw[0];
                        
                        for (let i = 0; i < headerRow.length; i++) {
                            const cell = headerRow[i] ? headerRow[i].toString().toLowerCase() : '';
                            if (cell.includes('nombre') || cell.includes('persona')) nameCol = i;
                            if (cell.includes('supervisora')) supervisorCol = i;
                            if (cell.includes('estado')) statusCol = i;
                        }
                        
                        for (let i = 1; i < scheduleDataRaw.length; i++) {
                            const row = scheduleDataRaw[i];
                            if (row && row[nameCol] && row[nameCol].toString().trim() !== '') {
                                const name = row[nameCol].toString().trim();
                                const supervisor = supervisorCol !== -1 && row[supervisorCol] ? row[supervisorCol].toString().trim() : '';
                                const status = statusCol !== -1 && row[statusCol] ? row[statusCol].toString().trim() : '';
                                
                                persons.push({ 
                                    name: name, 
                                    supervisor: supervisor,
                                    status: status
                                });
                            }
                        }
                    }
                }

                processSupervisorNames();

                if (!scheduleData.startDate) {
                    scheduleData.startDate = new Date('2025-11-03');
                }
                
                updateDateInput();
                initialize6x4Structure();
                
                autoHideVacioDays();
                
                updateMonthYear();
                initSchedule();
                
            } catch (error) {
                console.error('Error procesando Excel:', error);
                showStatus('Error al procesar el Excel: ' + error.message, 'error');
            }
        }

        // Inicializar estructura
        function initialize6x4Structure() {
            const targetDays = [1, 3, 4, 5, 6, 0];
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado'];
            
            scheduleData.groups.forEach((group, groupIndex) => {
                group.days = [];
                
                let currentDate = new Date(scheduleData.startDate);
                currentDate.setDate(currentDate.getDate() + (groupIndex * 7));
                
                while (currentDate.getDay() !== 1) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                for (let i = 0; i < 6; i++) {
                    while (!targetDays.includes(currentDate.getDay())) {
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    const dayName = dayNames[currentDate.getDay()];
                    const dayNumber = currentDate.getDate();
                    const month = currentDate.getMonth() + 1;
                    const year = currentDate.getFullYear();
                    
                    const dateString = `${dayName} ${dayNumber}/${month}/${year}`;
                    
                    const people = [];
                    if (persons.length > 0) {
                        const startIndex = (groupIndex * 12 + i * 2) % persons.length;
                        for (let j = 0; j < 2; j++) {
                            const personIndex = (startIndex + j) % persons.length;
                            if (persons[personIndex] && persons[personIndex].name.trim() !== '') {
                                people.push(persons[personIndex].name);
                            }
                        }
                    }
                    
                    const hasOnlyVacio = people.length > 0 && 
                                        people.every(person => 
                                            person.toLowerCase().includes('vacio') || 
                                            person.trim() === 'Vacio'
                                        );
                    
                    group.days.push({
                        day: dateString,
                        people: people,
                        date: new Date(currentDate),
                        originalDate: new Date(currentDate),
                        isEmpty: people.length === 0,
                        hidden: hasOnlyVacio
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });
        }

        // NUEVA FUNCI칍N: Eliminar persona seleccionada
        function deleteSelectedPerson() {
            if (!selectedPerson) {
                showStatus('Primero seleccione una persona', 'error');
                return;
            }
            
            const groupIdx = parseInt(selectedPerson.dataset.group);
            const dayIdx = parseInt(selectedPerson.dataset.day);
            const personIndex = parseInt(selectedPerson.dataset.index);
            
            const dayData = scheduleData.groups[groupIdx].days[dayIdx];
            
            if (personIndex < 0 || personIndex >= dayData.people.length) {
                showStatus('칈ndice de persona inv치lido', 'error');
                return;
            }
            
            const deletedPerson = dayData.people[personIndex];
            
            // Eliminar la persona
            dayData.people.splice(personIndex, 1);
            dayData.isEmpty = dayData.people.length === 0;
            
            // Si el d칤a queda vac칤o y solo ten칤a "Vacio", ocultarlo
            if (dayData.isEmpty && hasOnlyVacioNames(dayData)) {
                dayData.hidden = true;
            }
            
            selectedPerson = null;
            initSchedule();
            showStatus(`Persona "${deletedPerson}" eliminada correctamente`);
        }

        // Obtener el siguiente cuadro
        function getNextDay(groupIdx, dayIdx) {
            const group = scheduleData.groups[groupIdx];
            
            if (dayIdx < group.days.length - 1) {
                return { groupIdx: groupIdx, dayIdx: dayIdx + 1 };
            }
            
            if (groupIdx < scheduleData.groups.length - 1) {
                return { groupIdx: groupIdx + 1, dayIdx: 0 };
            }
            
            return { groupIdx: 0, dayIdx: 0 };
        }

        // Obtener el cuadro anterior
        function getPreviousDay(groupIdx, dayIdx) {
            const group = scheduleData.groups[groupIdx];
            
            if (dayIdx > 0) {
                return { groupIdx: groupIdx, dayIdx: dayIdx - 1 };
            }
            
            if (groupIdx > 0) {
                const prevGroup = scheduleData.groups[groupIdx - 1];
                return { groupIdx: groupIdx - 1, dayIdx: prevGroup.days.length - 1 };
            }
            
            const lastGroup = scheduleData.groups[scheduleData.groups.length - 1];
            return { groupIdx: scheduleData.groups.length - 1, dayIdx: lastGroup.days.length - 1 };
        }

        // Mover nombres hacia la derecha
        function shiftNamesRight(startGroupIdx, startDayIdx) {
            let currentGroupIdx = startGroupIdx;
            let currentDayIdx = startDayIdx;
            let movedPerson = null;
            
            let searchGroupIdx = startGroupIdx;
            let searchDayIdx = startDayIdx;
            
            while (true) {
                const nextDay = getNextDay(searchGroupIdx, searchDayIdx);
                
                if (nextDay.groupIdx === startGroupIdx && nextDay.dayIdx === startDayIdx) {
                    break;
                }
                
                const nextDayData = scheduleData.groups[nextDay.groupIdx].days[nextDay.dayIdx];
                if (nextDayData.people.length > 0) {
                    movedPerson = nextDayData.people.shift();
                    break;
                }
                
                searchGroupIdx = nextDay.groupIdx;
                searchDayIdx = nextDay.dayIdx;
            }
            
            if (movedPerson) {
                const startDay = scheduleData.groups[startGroupIdx].days[startDayIdx];
                startDay.people.push(movedPerson);
                startDay.isEmpty = false;
            }
            
            initSchedule();
            showStatus(movedPerson ? 'Persona agregada - Nombres movidos hacia la derecha' : 'No hay personas disponibles para mover');
        }

        // Mover nombres hacia la izquierda
        function shiftNamesLeft(startGroupIdx, startDayIdx) {
            const startDay = scheduleData.groups[startGroupIdx].days[startDayIdx];
            
            if (startDay.people.length === 0) {
                showStatus('No hay personas para quitar en este cuadro', 'error');
                return;
            }
            
            const removedPerson = startDay.people.pop();
            startDay.isEmpty = startDay.people.length === 0;
            
            let currentGroupIdx = startGroupIdx;
            let currentDayIdx = startDayIdx;
            let placed = false;
            
            while (!placed) {
                const nextDay = getNextDay(currentGroupIdx, currentDayIdx);
                
                const nextDayData = scheduleData.groups[nextDay.groupIdx].days[nextDay.dayIdx];
                if (nextDayData.people.length < 4) {
                    nextDayData.people.unshift(removedPerson);
                    nextDayData.isEmpty = false;
                    placed = true;
                    break;
                }
                
                currentGroupIdx = nextDay.groupIdx;
                currentDayIdx = nextDay.dayIdx;
                
                if (currentGroupIdx === startGroupIdx && currentDayIdx === startDayIdx) {
                    showStatus('No hay espacio disponible en otros cuadros', 'error');
                    return;
                }
            }
            
            initSchedule();
            showStatus(`Persona "${removedPerson}" movida a otro cuadro`);
        }

        // Agregar persona
        function addPerson(groupIdx, dayIdx) {
            const dayData = scheduleData.groups[groupIdx].days[dayIdx];
            
            if (dayData.people.length >= 4) {
                showStatus('M치ximo 4 personas por d칤a', 'error');
                return;
            }
            
            shiftNamesRight(groupIdx, dayIdx);
        }

        // Quitar persona
        function removePerson(groupIdx, dayIdx) {
            shiftNamesLeft(groupIdx, dayIdx);
        }

        // Alternar visibilidad del d칤a
        function toggleDayVisibility(groupIdx, dayIdx) {
            if (!isLoggedIn) {
                showStatus('Debe iniciar sesi칩n para ocultar/mostrar d칤as', 'error');
                return;
            }
            
            const dayData = scheduleData.groups[groupIdx].days[dayIdx];
            dayData.hidden = !dayData.hidden;
            
            initSchedule();
            showStatus(`D칤a ${dayData.hidden ? 'oculto' : 'mostrado'} correctamente`);
        }

        // SISTEMA DE MOVIMIENTO CON FLECHAS
        function selectPerson(personElement) {
            // Deseleccionar persona anterior
            if (selectedPerson) {
                selectedPerson.classList.remove('selected');
            }
            
            // Seleccionar nueva persona
            selectedPerson = personElement;
            personElement.classList.add('selected');
            
            // Mostrar controles de posici칩n en el d칤a (solo en desktop)
            if (!isMobileDevice) {
                const dayElement = personElement.closest('.calendar-day');
                document.querySelectorAll('.calendar-day').forEach(day => {
                    day.classList.remove('show-position-controls');
                });
                dayElement.classList.add('show-position-controls');
            }
            
            showStatus(`Persona seleccionada: ${personElement.textContent}. Use las flechas para mover o X para eliminar.`);
        }

        function movePersonUp() {
            if (!selectedPerson) {
                showStatus('Primero seleccione una persona', 'error');
                return;
            }
            
            const groupIdx = parseInt(selectedPerson.dataset.group);
            const dayIdx = parseInt(selectedPerson.dataset.day);
            const personIndex = parseInt(selectedPerson.dataset.index);
            
            const dayData = scheduleData.groups[groupIdx].days[dayIdx];
            
            if (personIndex === 0) {
                showStatus('La persona ya est치 en la primera posici칩n', 'error');
                return;
            }
            
            // Intercambiar con la persona de arriba
            const temp = dayData.people[personIndex];
            dayData.people[personIndex] = dayData.people[personIndex - 1];
            dayData.people[personIndex - 1] = temp;
            
            initSchedule();
            
            // Reseleccionar la persona en su nueva posici칩n
            setTimeout(() => {
                const newPersonElement = document.querySelector(`.calendar-day[data-group="${groupIdx}"][data-day="${dayIdx}"] .person-item[data-index="${personIndex - 1}"]`);
                if (newPersonElement) {
                    selectPerson(newPersonElement);
                }
            }, 100);
            
            showStatus(`Persona movida hacia arriba`);
        }

        function movePersonDown() {
            if (!selectedPerson) {
                showStatus('Primero seleccione una persona', 'error');
                return;
            }
            
            const groupIdx = parseInt(selectedPerson.dataset.group);
            const dayIdx = parseInt(selectedPerson.dataset.day);
            const personIndex = parseInt(selectedPerson.dataset.index);
            
            const dayData = scheduleData.groups[groupIdx].days[dayIdx];
            
            if (personIndex === dayData.people.length - 1) {
                showStatus('La persona ya est치 en la 칰ltima posici칩n', 'error');
                return;
            }
            
            // Intercambiar con la persona de abajo
            const temp = dayData.people[personIndex];
            dayData.people[personIndex] = dayData.people[personIndex + 1];
            dayData.people[personIndex + 1] = temp;
            
            initSchedule();
            
            // Reseleccionar la persona en su nueva posici칩n
            setTimeout(() => {
                const newPersonElement = document.querySelector(`.calendar-day[data-group="${groupIdx}"][data-day="${dayIdx}"] .person-item[data-index="${personIndex + 1}"]`);
                if (newPersonElement) {
                    selectPerson(newPersonElement);
                }
            }, 100);
            
            showStatus(`Persona movida hacia abajo`);
        }

        // NUEVO: Sistema de drag & drop para d칤as completos
        function initializeDayDragDrop() {
            if (isMobileDevice) return; // Solo en desktop
            
            document.querySelectorAll('.calendar-day').forEach(dayElement => {
                // Solo permitir arrastrar d칤as que no est칠n vac칤os u ocultos
                const groupIdx = parseInt(dayElement.dataset.group);
                const dayIdx = parseInt(dayElement.dataset.day);
                const dayData = scheduleData.groups[groupIdx].days[dayIdx];
                
                if (!dayData.hidden && !dayData.isEmpty) {
                    dayElement.draggable = true;
                    
                    dayElement.addEventListener('dragstart', function(e) {
                        if (!isLoggedIn) return;
                        
                        dayDragState.isDragging = true;
                        dayDragState.draggedDay = this;
                        dayDragState.sourceGroupIdx = groupIdx;
                        dayDragState.sourceDayIdx = dayIdx;
                        
                        this.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', '');
                    });
                    
                    dayElement.addEventListener('dragend', function(e) {
                        dayDragState.isDragging = false;
                        dayDragState.draggedDay = null;
                        this.classList.remove('dragging');
                        
                        // Limpiar zonas de drop
                        document.querySelectorAll('.calendar-day.day-drop-zone').forEach(day => {
                            day.classList.remove('day-drop-zone');
                        });
                    });
                }
            });

            // Eventos para los d칤as como zonas de drop
            document.querySelectorAll('.calendar-day').forEach(dayElement => {
                dayElement.addEventListener('dragover', function(e) {
                    if (!dayDragState.isDragging || !isLoggedIn) return;
                    
                    e.preventDefault();
                    const targetGroupIdx = parseInt(this.dataset.group);
                    const targetDayIdx = parseInt(this.dataset.day);
                    
                    // No permitir soltar en el mismo d칤a
                    if (targetGroupIdx === dayDragState.sourceGroupIdx && targetDayIdx === dayDragState.sourceDayIdx) {
                        return;
                    }
                    
                    this.classList.add('day-drop-zone');
                    e.dataTransfer.dropEffect = 'move';
                });
                
                dayElement.addEventListener('dragleave', function(e) {
                    this.classList.remove('day-drop-zone');
                });
                
                dayElement.addEventListener('drop', function(e) {
                    e.preventDefault();
                    
                    if (!dayDragState.isDragging || !isLoggedIn) return;
                    
                    const targetGroupIdx = parseInt(this.dataset.group);
                    const targetDayIdx = parseInt(this.dataset.day);
                    
                    // Intercambiar los datos de los d칤as
                    swapDays(
                        dayDragState.sourceGroupIdx, 
                        dayDragState.sourceDayIdx,
                        targetGroupIdx,
                        targetDayIdx
                    );
                    
                    this.classList.remove('day-drop-zone');
                });
            });
        }

        // NUEVA FUNCI칍N: Intercambiar d칤as completos
        function swapDays(sourceGroupIdx, sourceDayIdx, targetGroupIdx, targetDayIdx) {
            const sourceDay = scheduleData.groups[sourceGroupIdx].days[sourceDayIdx];
            const targetDay = scheduleData.groups[targetGroupIdx].days[targetDayIdx];
            
            // Intercambiar los datos
            const tempPeople = [...sourceDay.people];
            const tempIsEmpty = sourceDay.isEmpty;
            const tempHidden = sourceDay.hidden;
            
            sourceDay.people = [...targetDay.people];
            sourceDay.isEmpty = targetDay.isEmpty;
            sourceDay.hidden = targetDay.hidden;
            
            targetDay.people = tempPeople;
            targetDay.isEmpty = tempIsEmpty;
            targetDay.hidden = tempHidden;
            
            initSchedule();
            showStatus('D칤as intercambiados correctamente');
        }

        // SISTEMA DE DRAG & DROP MEJORADO PARA DESKTOP
        function initializeDesktopDragDrop() {
            // Inicializar arrastre para d칤as (para mover todo el contenido)
            document.querySelectorAll('.calendar-day').forEach(dayElement => {
                dayElement.addEventListener('dragover', handleDayDragOver);
                dayElement.addEventListener('dragleave', handleDayDragLeave);
                dayElement.addEventListener('drop', handleDayDrop);
            });
        }

        function initializeDesktopPersonDragDrop(personElement) {
            personElement.addEventListener('dragstart', function(e) {
                if (!isLoggedIn) return;
                
                dragState.isDragging = true;
                dragState.draggedElement = this;
                dragState.sourceGroupIdx = parseInt(this.dataset.group);
                dragState.sourceDayIdx = parseInt(this.dataset.day);
                dragState.sourcePersonIdx = parseInt(this.dataset.index);
                
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', '');
            });
            
            personElement.addEventListener('dragend', function(e) {
                dragState.isDragging = false;
                dragState.draggedElement = null;
                this.classList.remove('dragging');
                
                // Limpiar todos los indicadores
                document.querySelectorAll('.drop-indicator.visible').forEach(indicator => {
                    indicator.classList.remove('visible');
                });
                document.querySelectorAll('.calendar-day.drop-zone').forEach(day => {
                    day.classList.remove('drop-zone');
                });
                document.querySelectorAll('.person-list.drop-zone').forEach(list => {
                    list.classList.remove('drop-zone');
                });
            });
        }

        function handleDayDragOver(e) {
            if (!dragState.isDragging || !isLoggedIn) return;
            
            e.preventDefault();
            const dayElement = e.target.closest('.calendar-day');
            if (!dayElement || dayElement.classList.contains('hidden')) return;
            
            const targetGroupIdx = parseInt(dayElement.dataset.group);
            const targetDayIdx = parseInt(dayElement.dataset.day);
            const targetDay = scheduleData.groups[targetGroupIdx].days[targetDayIdx];
            
            // Permitir soltar si el d칤a est치 vac칤o o tiene menos de 4 personas
            if (targetDay.isEmpty || targetDay.people.length < 4) {
                dayElement.classList.add('drop-zone');
                e.dataTransfer.dropEffect = 'move';
            }
        }

        function handleDayDragLeave(e) {
            const dayElement = e.target.closest('.calendar-day');
            if (dayElement) {
                dayElement.classList.remove('drop-zone');
            }
        }

        function handleDayDrop(e) {
            e.preventDefault();
            
            if (!dragState.isDragging || !isLoggedIn) return;
            
            const dayElement = e.target.closest('.calendar-day');
            if (!dayElement) return;
            
            const targetGroupIdx = parseInt(dayElement.dataset.group);
            const targetDayIdx = parseInt(dayElement.dataset.day);
            
            // CORREGIDO: Solo mover la persona espec칤fica, no todo el contenido
            movePersonToDay(
                dragState.sourceGroupIdx, 
                dragState.sourceDayIdx, 
                dragState.sourcePersonIdx, 
                targetGroupIdx, 
                targetDayIdx,
                -1 // -1 indica agregar al final
            );
            
            dayElement.classList.remove('drop-zone');
        }

        // SISTEMA DE DRAG & DROP MEJORADO CON POSICIONAMIENTO
        function initializePersonListDragDrop() {
            document.querySelectorAll('.person-list').forEach(personList => {
                personList.addEventListener('dragover', handlePersonListDragOver);
                personList.addEventListener('dragleave', handlePersonListDragLeave);
                personList.addEventListener('drop', handlePersonListDrop);
            });
        }

        function handlePersonListDragOver(e) {
            if (!dragState.isDragging || !isLoggedIn) return;
            
            e.preventDefault();
            const personList = e.target.closest('.person-list');
            if (!personList) return;
            
            const dayElement = personList.closest('.calendar-day');
            const targetGroupIdx = parseInt(dayElement.dataset.group);
            const targetDayIdx = parseInt(dayElement.dataset.day);
            const targetDay = scheduleData.groups[targetGroupIdx].days[targetDayIdx];
            
            // Solo permitir si hay espacio
            if (targetDay.people.length >= 4) return;
            
            personList.classList.add('drop-zone');
            
            // Calcular posici칩n de drop
            const rect = personList.getBoundingClientRect();
            const y = e.clientY - rect.top;
            const height = rect.height;
            
            // Determinar posici칩n (arriba, medio, abajo)
            const position = calculateDropPosition(y, height, personList.children.length);
            
            // Mostrar indicador en la posici칩n correcta
            updateDropIndicators(personList, position);
            
            e.dataTransfer.dropEffect = 'move';
        }

        function handlePersonListDragLeave(e) {
            const personList = e.target.closest('.person-list');
            if (personList) {
                personList.classList.remove('drop-zone');
                hideAllDropIndicators(personList);
            }
        }

        function handlePersonListDrop(e) {
            e.preventDefault();
            
            if (!dragState.isDragging || !isLoggedIn) return;
            
            const personList = e.target.closest('.person-list');
            if (!personList) return;
            
            const dayElement = personList.closest('.calendar-day');
            const targetGroupIdx = parseInt(dayElement.dataset.group);
            const targetDayIdx = parseInt(dayElement.dataset.day);
            
            // Calcular posici칩n de drop
            const rect = personList.getBoundingClientRect();
            const y = e.clientY - rect.top;
            const height = rect.height;
            
            // Determinar posici칩n (arriba, medio, abajo)
            const position = calculateDropPosition(y, height, personList.children.length);
            
            // CORREGIDO: Solo mover la persona espec칤fica
            movePersonToDay(
                dragState.sourceGroupIdx, 
                dragState.sourceDayIdx, 
                dragState.sourcePersonIdx, 
                targetGroupIdx, 
                targetDayIdx,
                position
            );
            
            personList.classList.remove('drop-zone');
            hideAllDropIndicators(personList);
        }

        function calculateDropPosition(y, height, childCount) {
            const segmentHeight = height / childCount;
            const segmentIndex = Math.floor(y / segmentHeight);
            
            // Si estamos en la primera mitad del primer segmento, posici칩n 0 (arriba)
            if (segmentIndex === 0 && y < segmentHeight / 2) {
                return 0;
            }
            
            // Si estamos en la segunda mitad del 칰ltimo segmento, posici칩n -1 (abajo)
            if (segmentIndex === childCount - 1 && y > height - segmentHeight / 2) {
                return -1;
            }
            
            // En cualquier otro caso, posici칩n media (despu칠s del elemento en segmentIndex)
            return segmentIndex;
        }

        function updateDropIndicators(personList, position) {
            // Ocultar todos los indicadores primero
            hideAllDropIndicators(personList);
            
            // Mostrar el indicador en la posici칩n correcta
            const indicators = personList.querySelectorAll('.drop-indicator');
            
            if (position === 0) {
                // Arriba del todo
                if (indicators[0]) indicators[0].classList.add('visible');
            } else if (position === -1) {
                // Abajo del todo
                if (indicators[indicators.length - 1]) indicators[indicators.length - 1].classList.add('visible');
            } else {
                // En medio (despu칠s del elemento en posici칩n-1)
                if (indicators[position]) indicators[position].classList.add('visible');
            }
        }

        function hideAllDropIndicators(personList) {
            personList.querySelectorAll('.drop-indicator.visible').forEach(indicator => {
                indicator.classList.remove('visible');
            });
        }

        // Funci칩n mejorada para mover persona a un d칤a espec칤fico
        function movePersonToDay(sourceGroupIdx, sourceDayIdx, sourcePersonIdx, targetGroupIdx, targetDayIdx, targetPosition) {
            const sourceDay = scheduleData.groups[sourceGroupIdx].days[sourceDayIdx];
            const targetDay = scheduleData.groups[targetGroupIdx].days[targetDayIdx];
            
            // Verificar que el d칤a destino no est칠 oculto
            if (targetDay.hidden) {
                targetDay.hidden = false; // Mostrar el d칤a si estaba oculto
            }
            
            // Verificar l칤mite de personas
            if (targetDay.people.length >= 4) {
                showStatus('No se puede mover: d칤a destino ya tiene 4 personas', 'error');
                return;
            }
            
            // CORREGIDO: Solo mover la persona espec칤fica, no todo el contenido
            const movedPerson = sourceDay.people.splice(sourcePersonIdx, 1)[0];
            
            // Insertar en la posici칩n correcta
            if (targetPosition === -1) {
                // Agregar al final
                targetDay.people.push(movedPerson);
            } else if (targetPosition === 0) {
                // Agregar al principio
                targetDay.people.unshift(movedPerson);
            } else {
                // Insertar en posici칩n espec칤fica
                targetDay.people.splice(targetPosition, 0, movedPerson);
            }
            
            // Actualizar estados
            sourceDay.isEmpty = sourceDay.people.length === 0;
            targetDay.isEmpty = false;
            
            // Si el d칤a origen queda vac칤o, ocultarlo autom치ticamente si solo tiene "Vacio"
            if (sourceDay.isEmpty && hasOnlyVacioNames(sourceDay)) {
                sourceDay.hidden = true;
            }
            
            initSchedule();
            showStatus(`Persona "${movedPerson}" movida correctamente`);
        }

        // NUEVA FUNCI칍N: Sistema de desplazamiento autom치tico durante arrastre
        function startAutoScroll(direction) {
            if (scrollInterval) clearInterval(scrollInterval);
            
            scrollInterval = setInterval(() => {
                const currentScroll = window.scrollY || document.documentElement.scrollTop;
                
                if (direction === 'down') {
                    window.scrollTo(0, currentScroll + autoScrollSpeed);
                } else if (direction === 'up') {
                    window.scrollTo(0, currentScroll - autoScrollSpeed);
                }
            }, 16); // ~60fps
        }

        function stopAutoScroll() {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
            
            // Ocultar indicadores de desplazamiento
            document.getElementById('scrollTopIndicator').classList.remove('active');
            document.getElementById('scrollBottomIndicator').classList.remove('active');
        }

        // NUEVA FUNCI칍N: Sistema de drag & drop para dispositivos t치ctiles
        function initializeTouchDragDrop() {
            document.querySelectorAll('.person-item').forEach(personElement => {
                personElement.addEventListener('touchstart', handleTouchStart);
                personElement.addEventListener('touchmove', handleTouchMove);
                personElement.addEventListener('touchend', handleTouchEnd);
                personElement.addEventListener('touchcancel', handleTouchEnd);
            });

            document.querySelectorAll('.calendar-day').forEach(dayElement => {
                dayElement.addEventListener('touchmove', handleDayTouchMove);
                dayElement.addEventListener('touchend', handleDayTouchEnd);
                dayElement.addEventListener('touchcancel', handleDayTouchEnd);
            });
        }

        function handleTouchStart(e) {
            if (!isLoggedIn) return;
            
            touchStartTime = Date.now();
            touchStartElement = e.target.closest('.person-item');
            
            // Configurar timeout para iniciar arrastre despu칠s de 1 segundo
            touchDragTimeout = setTimeout(() => {
                if (touchStartElement) {
                    isTouchDragging = true;
                    
                    // Seleccionar la persona
                    selectPerson(touchStartElement);
                    
                    // Crear elemento fantasma para arrastre
                    const ghost = document.createElement('div');
                    ghost.className = 'drag-ghost';
                    ghost.textContent = touchStartElement.textContent;
                    document.body.appendChild(ghost);
                    
                    touchStartElement.classList.add('touch-dragging');
                    
                    // Actualizar posici칩n del fantasma
                    const touch = e.touches[0];
                    ghost.style.left = touch.clientX + 'px';
                    ghost.style.top = touch.clientY + 'px';
                    
                    // Marcar d칤a origen
                    const dayElement = touchStartElement.closest('.calendar-day');
                    dayElement.classList.add('day-move-source');
                }
            }, 1000);
        }

        function handleTouchMove(e) {
            if (!isTouchDragging || !touchStartElement) return;
            
            e.preventDefault();
            
            const touch = e.touches[0];
            const ghost = document.querySelector('.drag-ghost');
            
            if (ghost) {
                ghost.style.left = touch.clientX + 'px';
                ghost.style.top = touch.clientY + 'px';
            }
            
            // Verificar si estamos sobre un d칤a destino
            const elements = document.elementsFromPoint(touch.clientX, touch.clientY);
            const targetDay = elements.find(el => el.classList.contains('calendar-day'));
            
            // Limpiar clases de d칤a destino
            document.querySelectorAll('.calendar-day.day-move-target').forEach(day => {
                day.classList.remove('day-move-target');
            });
            
            if (targetDay && !targetDay.classList.contains('hidden')) {
                const sourceGroupIdx = parseInt(touchStartElement.dataset.group);
                const sourceDayIdx = parseInt(touchStartElement.dataset.day);
                const targetGroupIdx = parseInt(targetDay.dataset.group);
                const targetDayIdx = parseInt(targetDay.dataset.day);
                
                // No permitir soltar en el mismo d칤a
                if (sourceGroupIdx !== targetGroupIdx || sourceDayIdx !== targetDayIdx) {
                    targetDay.classList.add('day-move-target');
                }
            }
            
            // NUEVO: Sistema de desplazamiento autom치tico
            const scrollThreshold = 100; // Distancia desde los bordes para activar desplazamiento
            const viewportHeight = window.innerHeight;
            
            // Verificar si estamos cerca del borde inferior
            if (touch.clientY > viewportHeight - scrollThreshold) {
                document.getElementById('scrollBottomIndicator').classList.add('active');
                startAutoScroll('down');
            }
            // Verificar si estamos cerca del borde superior
            else if (touch.clientY < scrollThreshold) {
                document.getElementById('scrollTopIndicator').classList.add('active');
                startAutoScroll('up');
            }
            // Si no estamos cerca de los bordes, detener el desplazamiento
            else {
                stopAutoScroll();
            }
        }

        function handleTouchEnd(e) {
            clearTimeout(touchDragTimeout);
            stopAutoScroll();
            
            if (!isTouchDragging || !touchStartElement) {
                // Si no est치bamos arrastrando, es un click normal
                if (touchStartElement && Date.now() - touchStartTime < 1000) {
                    selectPerson(touchStartElement);
                }
                
                resetTouchState();
                return;
            }
            
            e.preventDefault();
            
            const touch = e.changedTouches[0];
            const elements = document.elementsFromPoint(touch.clientX, touch.clientY);
            const targetDay = elements.find(el => el.classList.contains('calendar-day'));
            
            if (targetDay && !targetDay.classList.contains('hidden')) {
                const sourceGroupIdx = parseInt(touchStartElement.dataset.group);
                const sourceDayIdx = parseInt(touchStartElement.dataset.day);
                const sourcePersonIdx = parseInt(touchStartElement.dataset.index);
                const targetGroupIdx = parseInt(targetDay.dataset.group);
                const targetDayIdx = parseInt(targetDay.dataset.day);
                
                // No permitir soltar en el mismo d칤a
                if (sourceGroupIdx !== targetGroupIdx || sourceDayIdx !== targetDayIdx) {
                    movePersonToDay(
                        sourceGroupIdx, 
                        sourceDayIdx, 
                        sourcePersonIdx, 
                        targetGroupIdx, 
                        targetDayIdx,
                        -1 // Agregar al final
                    );
                }
            }
            
            resetTouchState();
        }

        function handleDayTouchMove(e) {
            if (!isTouchDragging) return;
            e.preventDefault();
        }

        function handleDayTouchEnd(e) {
            // Solo procesar si estamos arrastrando
            if (!isTouchDragging) return;
            e.preventDefault();
        }

        function resetTouchState() {
            // Limpiar estado de arrastre t치ctil
            isTouchDragging = false;
            touchStartElement = null;
            
            // Remover elementos fantasma
            const ghost = document.querySelector('.drag-ghost');
            if (ghost) ghost.remove();
            
            // Limpiar clases
            document.querySelectorAll('.person-item.touch-dragging').forEach(el => {
                el.classList.remove('touch-dragging');
            });
            document.querySelectorAll('.calendar-day.day-move-source').forEach(el => {
                el.classList.remove('day-move-source');
            });
            document.querySelectorAll('.calendar-day.day-move-target').forEach(el => {
                el.classList.remove('day-move-target');
            });
        }

        // NUEVA FUNCI칍N: Abrir modal para seleccionar persona
        function openPersonSelectModal(groupIdx, dayIdx) {
            if (!isLoggedIn) {
                showStatus('Debe iniciar sesi칩n para agregar personas personalizadas', 'error');
                return;
            }
            
            const dayData = scheduleData.groups[groupIdx].days[dayIdx];
            if (dayData.people.length >= 4) {
                showStatus('M치ximo 4 personas por d칤a', 'error');
                return;
            }
            
            currentDayForPersonAdd = { groupIdx, dayIdx };
            
            // Limpiar y cargar la lista de personas
            const container = document.getElementById('personListContainer');
            container.innerHTML = '';
            
            // Filtrar personas que no est치n ya en el d칤a
            const availablePersons = persons.filter(person => 
                !dayData.people.includes(person.name)
            );
            
            if (availablePersons.length === 0) {
                container.innerHTML = '<p>No hay personas disponibles para agregar</p>';
            } else {
                availablePersons.forEach(person => {
                    const option = document.createElement('div');
                    option.className = 'person-option';
                    option.textContent = person.name;
                    option.dataset.personName = person.name;
                    option.addEventListener('click', function() {
                        // Toggle selecci칩n
                        document.querySelectorAll('.person-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');
                    });
                    container.appendChild(option);
                });
            }
            
            // Limpiar b칰squeda
            document.getElementById('personSearch').value = '';
            
            // Mostrar modal
            document.getElementById('personSelectModal').classList.add('active');
        }

        // NUEVA FUNCI칍N: Agregar persona seleccionada
        function addSelectedPerson() {
            if (!currentDayForPersonAdd) return;
            
            const selectedOption = document.querySelector('.person-option.selected');
            if (!selectedOption) {
                showStatus('Por favor seleccione una persona', 'error');
                return;
            }
            
            const personName = selectedOption.dataset.personName;
            const { groupIdx, dayIdx } = currentDayForPersonAdd;
            const dayData = scheduleData.groups[groupIdx].days[dayIdx];
            
            // Verificar que no exceda el l칤mite
            if (dayData.people.length >= 4) {
                showStatus('M치ximo 4 personas por d칤a', 'error');
                return;
            }
            
            // Agregar la persona
            dayData.people.push(personName);
            dayData.isEmpty = false;
            dayData.hidden = false; // Asegurar que el d칤a se muestre
            
            // Cerrar modal y actualizar
            document.getElementById('personSelectModal').classList.remove('active');
            initSchedule();
            showStatus(`Persona "${personName}" agregada correctamente`);
        }

        // NUEVA FUNCI칍N: Buscar personas
        function setupPersonSearch() {
            const searchInput = document.getElementById('personSearch');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const options = document.querySelectorAll('.person-option');
                
                options.forEach(option => {
                    const personName = option.dataset.personName.toLowerCase();
                    if (personName.includes(searchTerm)) {
                        option.style.display = 'block';
                    } else {
                        option.style.display = 'none';
                    }
                });
            });
        }

        // Inicializar el cronograma
        function initSchedule() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            if (scheduleData.groups[0].days.length === 0) {
                const dragInfo = document.createElement('div');
                dragInfo.className = 'drag-info';
                dragInfo.textContent = 'No hay datos disponibles. Cargue un archivo Excel.';
                grid.appendChild(dragInfo);
                return;
            }

            scheduleData.groups.forEach((group, groupIdx) => {
                const groupHeader = document.createElement('div');
                groupHeader.className = 'group-header';
                groupHeader.textContent = group.name;
                groupHeader.style.background = group.color;
                grid.appendChild(groupHeader);

                group.days.forEach((dayData, dayIdx) => {
                    if (hasOnlyVacioNames(dayData) && !dayData.hidden && isLoggedIn) {
                        dayData.hidden = true;
                    }
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = `calendar-day ${dayData.isEmpty ? 'empty' : ''} ${dayData.hidden ? 'hidden' : ''}`;
                    dayDiv.dataset.group = groupIdx;
                    dayDiv.dataset.day = dayIdx;
                    
                    if (dayData.day.toLowerCase().includes('domingo')) {
                        dayDiv.classList.add('sunday');
                    }

                    const header = document.createElement('div');
                    header.className = 'day-header';
                    header.textContent = dayData.day;

                    const content = document.createElement('div');
                    content.className = 'day-content';
                    
                    // Controles de posici칩n (solo en m칩viles o cuando hay persona seleccionada)
                    if (isLoggedIn && !dayData.hidden && !dayData.isEmpty) {
                        const positionControls = document.createElement('div');
                        positionControls.className = 'position-controls';
                        
                        const upBtn = document.createElement('button');
                        upBtn.className = 'position-btn up';
                        upBtn.innerHTML = '拘勇';
                        upBtn.title = 'Mover persona hacia arriba';
                        upBtn.onclick = (e) => {
                            e.stopPropagation();
                            movePersonUp();
                        };
                        positionControls.appendChild(upBtn);
                        
                        const downBtn = document.createElement('button');
                        downBtn.className = 'position-btn down';
                        downBtn.innerHTML = '拘勇';
                        downBtn.title = 'Mover persona hacia abajo';
                        downBtn.onclick = (e) => {
                            e.stopPropagation();
                            movePersonDown();
                        };
                        positionControls.appendChild(downBtn);
                        
                        dayDiv.appendChild(positionControls);
                        
                        // En m칩viles, las flechas siempre visibles
                        if (isMobileDevice) {
                            dayDiv.classList.add('show-position-controls');
                        }
                    }

                    if (dayData.hidden) {
                        const noActivityDiv = document.createElement('div');
                        noActivityDiv.className = 'no-activity';
                        noActivityDiv.textContent = 'Sin actividad';
                        content.appendChild(noActivityDiv);
                    } else if (dayData.isEmpty) {
                        const noActivityDiv = document.createElement('div');
                        noActivityDiv.className = 'no-activity';
                        noActivityDiv.textContent = 'Sin actividad';
                        content.appendChild(noActivityDiv);
                    } else {
                        const personList = document.createElement('div');
                        personList.className = 'person-list';
                        
                        // Agregar indicadores de drop
                        const topIndicator = document.createElement('div');
                        topIndicator.className = 'drop-indicator top';
                        personList.appendChild(topIndicator);
                        
                        if (dayData.people.length === 4) {
                            const morningLabel = document.createElement('div');
                            morningLabel.className = 'time-label';
                            morningLabel.textContent = 'por la ma침ana';
                            personList.appendChild(morningLabel);
                            
                            dayData.people.slice(0, 2).forEach((person, index) => {
                                const personDiv = createPersonElement(person, groupIdx, dayIdx, index);
                                personList.appendChild(personDiv);
                                
                                // Agregar indicador despu칠s de cada persona
                                if (index < 1) {
                                    const indicator = document.createElement('div');
                                    indicator.className = 'drop-indicator';
                                    personList.appendChild(indicator);
                                }
                            });
                            
                            const afternoonLabel = document.createElement('div');
                            afternoonLabel.className = 'time-label';
                            afternoonLabel.textContent = 'por la tarde';
                            personList.appendChild(afternoonLabel);
                            
                            dayData.people.slice(2, 4).forEach((person, index) => {
                                const personDiv = createPersonElement(person, groupIdx, dayIdx, index + 2);
                                personList.appendChild(personDiv);
                                
                                // Agregar indicador despu칠s de cada persona
                                if (index < 1) {
                                    const indicator = document.createElement('div');
                                    indicator.className = 'drop-indicator';
                                    personList.appendChild(indicator);
                                }
                            });
                        } else {
                            dayData.people.forEach((person, index) => {
                                const personDiv = createPersonElement(person, groupIdx, dayIdx, index);
                                personList.appendChild(personDiv);
                                
                                // Agregar indicador despu칠s de cada persona
                                if (index < dayData.people.length - 1) {
                                    const indicator = document.createElement('div');
                                    indicator.className = 'drop-indicator';
                                    personList.appendChild(indicator);
                                }
                            });
                        }
                        
                        // Agregar indicador final
                        const bottomIndicator = document.createElement('div');
                        bottomIndicator.className = 'drop-indicator bottom';
                        personList.appendChild(bottomIndicator);
                        
                        content.appendChild(personList);
                    }

                    if (dayData.people.length > 0 && !dayData.hidden) {
                        const countDiv = document.createElement('div');
                        countDiv.className = 'person-count';
                        countDiv.textContent = dayData.people.length;
                        dayDiv.appendChild(countDiv);
                    }

                    const actionButtons = document.createElement('div');
                    actionButtons.className = 'day-actions';
                    
                    if (isLoggedIn) {
                        // Bot칩n para agregar persona personalizada
                        const customAddBtn = document.createElement('button');
                        customAddBtn.className = 'action-btn custom-add-btn';
                        customAddBtn.innerHTML = '游녻';
                        customAddBtn.title = 'Agregar persona espec칤fica';
                        customAddBtn.onclick = (e) => {
                            e.stopPropagation();
                            openPersonSelectModal(groupIdx, dayIdx);
                        };
                        actionButtons.appendChild(customAddBtn);
                        
                        const addBtn = document.createElement('button');
                        addBtn.className = 'action-btn add-btn';
                        addBtn.innerHTML = '+';
                        addBtn.title = 'Agregar persona autom치tica';
                        addBtn.onclick = (e) => {
                            e.stopPropagation();
                            addPerson(groupIdx, dayIdx);
                        };
                        actionButtons.appendChild(addBtn);
                    }
                    
                    if (isLoggedIn) {
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'action-btn remove-btn';
                        removeBtn.innerHTML = '-';
                        removeBtn.title = 'Quitar 칰ltima persona';
                        removeBtn.onclick = (e) => {
                            e.stopPropagation();
                            removePerson(groupIdx, dayIdx);
                        };
                        actionButtons.appendChild(removeBtn);
                    }
                    
                    if (isLoggedIn) {
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'action-btn toggle-btn';
                        toggleBtn.innerHTML = dayData.hidden ? '游녜勇' : '游녜勇';
                        toggleBtn.title = dayData.hidden ? 'Mostrar d칤a' : 'Ocultar d칤a';
                        toggleBtn.onclick = (e) => {
                            e.stopPropagation();
                            toggleDayVisibility(groupIdx, dayIdx);
                        };
                        actionButtons.appendChild(toggleBtn);
                    }

                    dayDiv.appendChild(actionButtons);
                    dayDiv.appendChild(header);
                    dayDiv.appendChild(content);
                    grid.appendChild(dayDiv);
                });
            });

            applyFontStyles();
            
            // Inicializar drag & drop seg칰n el dispositivo
            if (isMobileDevice) {
                // En m칩viles usar sistema t치ctil
                setTimeout(() => {
                    initializeTouchDragDrop();
                }, 100);
            } else {
                initializeDesktopDragDrop();
                initializeDayDragDrop(); // Inicializar drag & drop de d칤as
                setTimeout(() => {
                    initializePersonListDragDrop();
                }, 100);
            }
        }

        function createPersonElement(person, groupIdx, dayIdx, index) {
            const personDiv = document.createElement('div');
            personDiv.className = 'person-item';
            personDiv.dataset.group = groupIdx;
            personDiv.dataset.day = dayIdx;
            personDiv.dataset.index = index;
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'person-name';
            nameSpan.textContent = person;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-person-btn';
            deleteBtn.innerHTML = '칑';
            deleteBtn.title = 'Eliminar persona';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                selectPerson(personDiv);
                deleteSelectedPerson();
            };
            
            personDiv.appendChild(nameSpan);
            personDiv.appendChild(deleteBtn);
            
            if (isLoggedIn) {
                if (isMobileDevice) {
                    // En m칩viles: touch para seleccionar y arrastrar
                    personDiv.addEventListener('click', function(e) {
                        // Solo procesar si no est치bamos arrastrando
                        if (!isTouchDragging) {
                            e.stopPropagation();
                            selectPerson(this);
                        }
                    });
                } else {
                    // En desktop: drag & drop
                    personDiv.draggable = true;
                    
                    // Click para seleccionar y mostrar flechas
                    personDiv.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectPerson(this);
                    });
                    
                    // Sistema de drag & drop para desktop
                    initializeDesktopPersonDragDrop(personDiv);
                }
            }
            
            return personDiv;
        }

        // Sistema de login
        document.getElementById('loginSubmit').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showStatus('Ingrese usuario y contrase침a', 'error');
                return;
            }

            if (Object.keys(VALID_USERS).length === 0) {
                showStatus('No hay usuarios configurados en el sistema', 'error');
                return;
            }

            if (VALID_USERS[username] && VALID_USERS[username] === password) {
                isLoggedIn = true;
                currentUser = username;
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('userInfo').innerHTML = `
                    <span>游녻 ${username}</span>
                    <button class="btn btn-danger" id="logoutBtn">Cerrar Sesi칩n</button>
                `;
                
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    isLoggedIn = false;
                    currentUser = null;
                    document.getElementById('userInfo').innerHTML = `
                        <button class="btn btn-primary" id="loginBtn">游댏 Iniciar Sesi칩n</button>
                    `;
                    document.getElementById('loginBtn').addEventListener('click', () => {
                        document.getElementById('loginModal').classList.add('active');
                    });
                    initSchedule();
                    showStatus('Sesi칩n cerrada correctamente');
                });

                autoHideVacioDays();
                initSchedule();
                showStatus(`Bienvenido/a ${username}`);
            } else {
                showStatus('Usuario o contrase침a incorrectos', 'error');
            }
        });

        // Actualizar Excel
        document.getElementById('updateExcelBtn').addEventListener('click', function() {
            if (!currentExcelData) {
                showStatus('No hay archivo Excel cargado para actualizar', 'error');
                return;
            }

            try {
                const scheduleSheetName = currentExcelData.SheetNames.find(name => 
                    name.toLowerCase().includes('cronograma') || 
                    name.toLowerCase().includes('limpieza')
                ) || currentExcelData.SheetNames[0];

                const newData = originalExcelStructure ? [...originalExcelStructure[scheduleSheetName]] : [];
                
                if (newData.length === 0) {
                    newData.push(['Nombre', 'Supervisora', 'Fecha Asignada', 'Estado']);
                }
                
                let nameCol = -1, supervisorCol = -1, dateCol = -1, statusCol = -1;
                if (newData.length > 0) {
                    const headerRow = newData[0];
                    for (let i = 0; i < headerRow.length; i++) {
                        const cell = headerRow[i] ? headerRow[i].toString().toLowerCase() : '';
                        if (cell.includes('nombre')) nameCol = i;
                        if (cell.includes('supervisora')) supervisorCol = i;
                        if (cell.includes('fecha') || cell.includes('d칤a')) dateCol = i;
                        if (cell.includes('estado')) statusCol = i;
                    }
                    
                    if (statusCol === -1) {
                        statusCol = headerRow.length;
                        newData[0].push('Estado');
                    }
                }
                
                const headerRow = newData[0];
                newData.splice(1, newData.length - 1);
                
                scheduleData.groups.forEach((group, groupIndex) => {
                    group.days.forEach(day => {
                        const shouldBeHidden = hasOnlyVacioNames(day);
                        if (shouldBeHidden && !day.hidden && isLoggedIn) {
                            day.hidden = true;
                        }
                        
                        if (day.people.length === 0) {
                            const newRow = new Array(headerRow.length).fill('');
                            
                            if (nameCol !== -1) newRow[nameCol] = 'Vacio';
                            if (dateCol !== -1) newRow[dateCol] = day.day;
                            if (statusCol !== -1) {
                                newRow[statusCol] = day.hidden ? 'Oculto (Vacio)' : 'Activo';
                            }
                            
                            newData.push(newRow);
                        } else {
                            day.people.forEach(person => {
                                if (person && person.trim() !== '') {
                                    const newRow = new Array(headerRow.length).fill('');
                                    
                                    if (nameCol !== -1) newRow[nameCol] = person;
                                    if (dateCol !== -1) newRow[dateCol] = day.day;
                                    if (supervisorCol !== -1) {
                                        const personData = persons.find(p => p.name === person);
                                        if (personData && personData.supervisor) {
                                            newRow[supervisorCol] = personData.supervisor;
                                        } else {
                                            newRow[supervisorCol] = '';
                                        }
                                    }
                                    if (statusCol !== -1) {
                                        const status = day.hidden ? 
                                            (hasOnlyVacioNames(day) ? 'Oculto (Vacio)' : 'Oculto') : 
                                            'Activo';
                                        newRow[statusCol] = status;
                                    }
                                    
                                    newData.push(newRow);
                                }
                            });
                        }
                    });
                });

                const newWorksheet = XLSX.utils.aoa_to_sheet(newData);
                currentExcelData.Sheets[scheduleSheetName] = newWorksheet;

                const outputFilename = currentExcelFile || 'Limpieza_igle_actualizado.xlsx';
                XLSX.writeFile(currentExcelData, outputFilename);
                showStatus(`Excel actualizado correctamente: ${outputFilename}`);
                
            } catch (error) {
                console.error('Error actualizando Excel:', error);
                showStatus('Error al actualizar el Excel: ' + error.message, 'error');
            }
        });

        function updateDateInput() {
            const dateInput = document.getElementById('startDate');
            if (scheduleData.startDate) {
                dateInput.valueAsDate = scheduleData.startDate;
            }
        }

        function updateMonthYear() {
            if (!scheduleData.startDate) return;
            
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const startMonth = monthNames[scheduleData.startDate.getMonth()];
            const startYear = scheduleData.startDate.getFullYear();
            
            const endDate = new Date(scheduleData.startDate);
            endDate.setDate(endDate.getDate() + 27);
            const endMonth = monthNames[endDate.getMonth()];
            const endYear = endDate.getFullYear();
            
            document.getElementById('currentMonthYear').textContent = 
                `${startMonth} ${startYear} - ${endMonth} ${endYear}`;
        }

        // Event listeners restantes
        document.getElementById('fontIncreaseBtn').addEventListener('click', () => {
            const sizes = ['xs', 'sm', 'md', 'lg', 'xl'];
            const currentIndex = sizes.indexOf(currentFontSize);
            if (currentIndex < sizes.length - 1) {
                currentFontSize = sizes[currentIndex + 1];
                applyFontStyles();
                showStatus(`Tama침o de fuente: ${currentFontSize.toUpperCase()}`);
            }
        });

        document.getElementById('fontDecreaseBtn').addEventListener('click', () => {
            const sizes = ['xs', 'sm', 'md', 'lg', 'xl'];
            const currentIndex = sizes.indexOf(currentFontSize);
            if (currentIndex > 0) {
                currentFontSize = sizes[currentIndex - 1];
                applyFontStyles();
                showStatus(`Tama침o de fuente: ${currentFontSize.toUpperCase()}`);
            }
        });

        document.getElementById('fontFamilySelect').addEventListener('change', (e) => {
            currentFontFamily = e.target.value;
            applyFontStyles();
            showStatus(`Fuente cambiada a: ${currentFontFamily}`);
        });

        document.getElementById('loginBtn').addEventListener('click', () => {
            document.getElementById('loginModal').classList.add('active');
        });

        document.getElementById('loginCancel').addEventListener('click', () => {
            document.getElementById('loginModal').classList.remove('active');
        });

        // Descargar imagen simplificada (sin opci칩n de orientaci칩n)
        document.getElementById('downloadBtn').addEventListener('click', function() {
            downloadImage();
        });

        function downloadImage() {
            document.querySelector('.container').classList.add('download-mode');
            
            const config = {
                scale: 2,
                backgroundColor: '#ffffff',
                useCORS: true,
                logging: false
            };
            
            html2canvas(document.querySelector('.container'), config).then(canvas => {
                document.querySelector('.container').classList.remove('download-mode');
                
                const link = document.createElement('a');
                link.download = `cronograma-limpieza.png`;
                link.href = canvas.toDataURL();
                link.click();
                showStatus(`Imagen descargada correctamente`);
            }).catch(error => {
                document.querySelector('.container').classList.remove('download-mode');
                console.error('Error al descargar imagen:', error);
                showStatus('Error al descargar la imagen', 'error');
            });
        }

        // NUEVOS EVENT LISTENERS PARA EL MODAL DE PERSONAS
        document.getElementById('confirmPersonBtn').addEventListener('click', addSelectedPerson);
        
        document.getElementById('cancelPersonBtn').addEventListener('click', () => {
            document.getElementById('personSelectModal').classList.remove('active');
        });

        document.getElementById('applyDateBtn').addEventListener('click', function() {
            const dateInput = document.getElementById('startDate');
            const selectedDate = new Date(dateInput.value);
            
            if (selectedDate.getDay() !== 1) {
                showStatus('Por favor seleccione un lunes como fecha de inicio', 'error');
                return;
            }
            
            const currentNames = [];
            const currentHiddenStates = [];
            scheduleData.groups.forEach(group => {
                group.days.forEach(day => {
                    currentNames.push([...day.people]);
                    currentHiddenStates.push(day.hidden);
                });
            });
            
            scheduleData.startDate = selectedDate;
            initialize6x4Structure();
            
            let nameIndex = 0;
            let hiddenIndex = 0;
            scheduleData.groups.forEach(group => {
                group.days.forEach(day => {
                    if (nameIndex < currentNames.length && currentNames[nameIndex].length > 0) {
                        day.people = [...currentNames[nameIndex]];
                        day.isEmpty = false;
                    }
                    if (hiddenIndex < currentHiddenStates.length) {
                        day.hidden = currentHiddenStates[hiddenIndex];
                    }
                    nameIndex++;
                    hiddenIndex++;
                });
            });
            
            updateMonthYear();
            initSchedule();
            showStatus('Fecha aplicada correctamente - Nombres preservados');
        });

        document.getElementById('loadExcelBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Por favor seleccione un archivo Excel', 'error');
                return;
            }
            
            showStatus('Cargando archivo Excel...');
            
            loadExcelManually(file).catch(error => {
                console.error('Error cargando Excel manualmente:', error);
                showStatus('Error al cargar el archivo: ' + error.message, 'error');
            });
        });

        // Inicializar aplicaci칩n
        loadExcelAutomatically();
        setupPersonSearch();
    </script>
</body>
</html>
