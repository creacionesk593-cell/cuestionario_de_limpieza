<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Limpieza Mensual</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            touch-action: pan-y;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #f8f9fa;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: #00b4db;
            color: white;
        }

        .btn-primary:hover {
            background: #0083b0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,180,219,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            padding: 30px;
            background: #f8f9fa;
        }

        .calendar-day {
            background: white;
            border-radius: 10px;
            padding: 15px;
            min-height: 160px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
        }

        .download-mode .day-actions,
        .download-mode .person-count,
        .download-mode .notes-section,
        .download-mode .controls,
        .download-mode .file-upload-section,
        .download-mode #statusMessage {
            display: none !important;
        }

        .calendar-day.hidden {
            opacity: 0.5;
            background-color: #f0f0f0;
        }

        .calendar-day.drag-over {
            border: 3px dashed #00b4db;
            background: #e3f2fd;
        }

        .calendar-day.sunday {
            background: #ffeaea;
        }

        .calendar-day.empty {
            background: #f8f9fa;
            opacity: 0.7;
        }

        .day-header {
            font-size: 16px;
            font-weight: bold;
            color: #00b4db;
            margin-bottom: 10px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .sunday .day-header {
            color: #d63031;
        }

        .day-content {
            font-size: 15px;
            color: #333;
            line-height: 1.4;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .no-activity {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            color: #6c757d;
            padding: 10px;
        }

        .person-item {
            padding: 6px 8px;
            margin: 3px 0;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            position: relative;
        }

        .person-item:hover {
            background: #e9ecef;
            transform: scale(1.02);
        }

        .person-item.dragging {
            opacity: 0.5;
            background: #cce7ff;
        }

        .person-item.drag-over {
            background: #e3f2fd;
            border: 2px dashed #00b4db;
        }

        .person-item.drop-above {
            border-top: 3px solid #00b4db;
        }

        .person-item.drop-below {
            border-bottom: 3px solid #00b4db;
        }

        .person-item.position-indicator {
            background: #e3f2fd;
            border: 2px dashed #00b4db;
            color: #00b4db;
            font-weight: bold;
            text-align: center;
        }

        .group-header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 8px;
            margin-top: 15px;
        }

        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .login-modal.active {
            display: flex;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            max-width: 350px;
            width: 90%;
        }

        .login-box h2 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            font-size: 1.6em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: bold;
            font-size: 16px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00b4db;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info span {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .notes-section {
            background: #fff3cd;
            padding: 15px 20px;
            margin: 15px 25px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .notes-section h3 {
            margin-bottom: 8px;
            color: #856404;
            font-size: 17px;
        }

        .notes-section p {
            margin: 4px 0;
            color: #856404;
            font-size: 15px;
        }

        .file-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-input-container input[type="file"] {
            display: none;
        }

        .file-input-label {
            padding: 10px 14px;
            background: #6c757d;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s;
        }

        .drag-info {
            text-align: center;
            padding: 8px;
            color: #6c757d;
            font-style: italic;
            grid-column: 1 / -1;
            font-size: 15px;
        }

        .status-message {
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
            text-align: center;
            font-size: 15px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .date-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .file-upload-section {
            background: #e9f7fe;
            padding: 12px 15px;
            margin: 15px 25px;
            border-radius: 8px;
            border-left: 4px solid #00b4db;
        }

        .day-actions {
            position: absolute;
            bottom: 6px;
            right: 6px;
            display: flex;
            gap: 4px;
        }

        .position-controls {
            position: absolute;
            top: 6px;
            left: 6px;
            display: flex;
            gap: 2px;
            flex-direction: column;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .position-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: #6c757d;
            color: white;
        }

        .position-btn:hover {
            transform: scale(1.1);
        }

        .position-btn.up {
            background: #28a745;
        }

        .position-btn.down {
            background: #007bff;
        }

        .add-btn {
            background: #28a745;
            color: white;
        }

        .add-btn:hover {
            background: #218838;
            transform: scale(1.1);
        }

        .clear-btn {
            background: #dc3545;
            color: white;
        }

        .clear-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .remove-btn {
            background: #ffc107;
            color: #212529;
        }

        .remove-btn:hover {
            background: #e0a800;
            transform: scale(1.1);
        }

        .toggle-btn {
            background: #6c757d;
            color: white;
        }

        .toggle-btn:hover {
            background: #5a6268;
            transform: scale(1.1);
        }

        .person-count {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .time-label {
            font-size: 10px;
            color: #dc3545;
            font-weight: bold;
            text-align: center;
            padding: 2px 4px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 2px;
            margin: 2px 0;
        }

        .person-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: 5px;
        }

        .font-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .font-btn {
            width: 38px;
            height: 38px;
            border: none;
            border-radius: 4px;
            background: #6c757d;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .font-select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .font-xs .person-item { font-size: 10px; padding: 3px 5px; }
        .font-sm .person-item { font-size: 12px; padding: 4px 6px; }
        .font-md .person-item { font-size: 14px; padding: 5px 7px; }
        .font-lg .person-item { font-size: 16px; padding: 6px 8px; }
        .font-xl .person-item { font-size: 18px; padding: 7px 9px; }

        .font-xs .day-header { font-size: 13px; }
        .font-sm .day-header { font-size: 14px; }
        .font-md .day-header { font-size: 16px; }
        .font-lg .day-header { font-size: 18px; }
        .font-xl .day-header { font-size: 20px; }

        .orientation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .orientation-modal.active {
            display: flex;
        }

        .orientation-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .orientation-box h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.6em;
        }

        .orientation-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .orientation-option {
            padding: 15px 25px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .orientation-option:hover {
            border-color: #00b4db;
            background: #f0f9ff;
        }

        .orientation-option.selected {
            border-color: #00b4db;
            background: #e3f2fd;
        }

        /* Estilos para el sistema t√°ctil */
        .person-item.touch-dragging {
            position: fixed;
            z-index: 10000;
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            background: #cce7ff !important;
            opacity: 0.9;
            pointer-events: none;
        }

        .calendar-day.drop-target {
            border: 3px solid #28a745;
            background: #f0fff4;
            transform: scale(1.02);
        }

        .calendar-day.day-move-source {
            border: 3px solid #ffc107;
            background: #fffbf0;
            transform: scale(1.02);
        }

        .calendar-day.day-move-target {
            border: 3px solid #28a745;
            background: #f0fff4;
            transform: scale(1.02);
        }

        .mobile-menu {
            position: fixed;
            background: white;
            border: 2px solid #00b4db;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            min-width: 180px;
        }

        .mobile-menu-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 2px 0;
            border: none;
            border-radius: 4px;
            background: #00b4db;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .mobile-menu-btn:hover {
            background: #0083b0;
        }

        .mobile-menu-btn.cancel {
            background: #6c757d;
        }

        .mobile-menu-btn.cancel:hover {
            background: #5a6268;
        }

        .drag-ghost {
            position: fixed;
            background: #cce7ff;
            border: 2px dashed #00b4db;
            border-radius: 4px;
            padding: 8px;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.8;
            transform: translate(-50%, -50%);
        }

        .day-drag-ghost {
            position: fixed;
            background: #fffbf0;
            border: 3px dashed #ffc107;
            border-radius: 10px;
            padding: 15px;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.9;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            min-width: 150px;
            text-align: center;
        }

        .position-indicator-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .position-indicator-modal.active {
            display: flex;
        }

        .position-indicator-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            max-width: 300px;
            width: 90%;
            text-align: center;
        }

        .position-indicator-box h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .position-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .position-option {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .position-option:hover {
            border-color: #00b4db;
            background: #f0f9ff;
        }

        .position-option.selected {
            border-color: #00b4db;
            background: #e3f2fd;
        }

        @media (max-width: 1200px) {
            .calendar-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
                padding: 15px;
                gap: 6px;
            }

            .header h1 {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .calendar-day {
                min-height: 150px;
                padding: 12px;
            }

            .person-item {
                padding: 8px;
                font-size: 13px;
            }

            .day-actions {
                position: relative;
                bottom: auto;
                right: auto;
                justify-content: center;
                margin-top: 8px;
            }

            .position-controls {
                position: relative;
                top: auto;
                left: auto;
                flex-direction: row;
                justify-content: center;
                margin-bottom: 5px;
            }

            .action-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .position-btn {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }

            body {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ CRONOGRAMA DE LIMPIEZA MENSUAL</h1>
            <p id="currentMonthYear">Cargando...</p>
        </div>

        <div class="controls">
            <div class="date-controls">
                <label>Fecha inicio (Lunes):</label>
                <input type="date" id="startDate" value="2025-11-03">
                <button class="btn btn-primary" id="applyDateBtn">Aplicar Fecha</button>
            </div>

            <div class="user-info" id="userInfo">
                <button class="btn btn-primary" id="loginBtn">üîê Iniciar Sesi√≥n</button>
            </div>

            <div class="font-controls">
                <select class="font-select" id="fontFamilySelect">
                    <option value="Arial">Arial</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                </select>
                <button class="font-btn" id="fontDecreaseBtn" title="Disminuir fuente">A-</button>
                <button class="font-btn" id="fontIncreaseBtn" title="Aumentar fuente">A+</button>
            </div>

            <div>
                <button class="btn btn-success" id="downloadBtn">üì• Descargar Imagen</button>
                <button class="btn btn-primary" id="updateExcelBtn">üíæ Actualizar Excel</button>
            </div>
        </div>

        <div id="statusMessage"></div>

        <div class="file-upload-section" id="fileUploadSection" style="display: none;">
            <h3>üìÅ Cargar Archivo Excel</h3>
            <p>No se encontr√≥ el archivo "Limpieza_igle.xlsx" en la misma carpeta. Por favor, cargue el archivo manualmente:</p>
            <div class="file-input-container">
                <input type="file" id="excelFile" accept=".xlsx, .xls">
                <label for="excelFile" class="file-input-label">Seleccionar Archivo Excel</label>
                <button class="btn btn-primary" id="loadExcelBtn">Cargar</button>
            </div>
        </div>

        <div id="calendarGrid" class="calendar-grid">
            <div class="drag-info" id="dragInfo">
                ‚¨ÜÔ∏è Buscando archivo Excel en la misma carpeta...
            </div>
        </div>
    </div>

    <!-- MODAL DE LOGIN -->
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <h2>Iniciar Sesi√≥n</h2>
            <div class="form-group">
                <label>Usuario:</label>
                <input type="text" id="username" placeholder="Ingrese su usuario">
            </div>
            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="password" placeholder="Ingrese su contrase√±a">
            </div>
            <button class="btn btn-primary" style="width: 100%;" id="loginSubmit">Ingresar</button>
            <button class="btn btn-danger" style="width: 100%; margin-top: 8px;" id="loginCancel">Cancelar</button>
        </div>
    </div>

    <!-- MODAL DE ORIENTACI√ìN PARA DESCARGA -->
    <div class="orientation-modal" id="orientationModal">
        <div class="orientation-box">
            <h2>Seleccione la orientaci√≥n</h2>
            <div class="orientation-options">
                <div class="orientation-option" data-orientation="horizontal">
                    üìÑ Horizontal
                </div>
                <div class="orientation-option" data-orientation="vertical">
                    üìÑ Vertical
                </div>
            </div>
            <button class="btn btn-primary" id="confirmDownloadBtn">Descargar</button>
            <button class="btn btn-danger" id="cancelDownloadBtn" style="margin-top: 10px;">Cancelar</button>
        </div>
    </div>

    <!-- MODAL PARA SELECCI√ìN DE POSICI√ìN -->
    <div class="position-indicator-modal" id="positionIndicatorModal">
        <div class="position-indicator-box">
            <h3>Seleccione la posici√≥n</h3>
            <div class="position-options">
                <div class="position-option" data-position="0">‚¨ÜÔ∏è Arriba del todo</div>
                <div class="position-option" data-position="1">‚ÜïÔ∏è Entre nombres</div>
                <div class="position-option" data-position="2">‚¨áÔ∏è Abajo del todo</div>
            </div>
            <button class="btn btn-primary" id="confirmPositionBtn">Confirmar</button>
            <button class="btn btn-danger" id="cancelPositionBtn" style="margin-top: 10px;">Cancelar</button>
        </div>
    </div>

    <script>
        // Variables globales
        let persons = [];
        let isLoggedIn = false;
        let currentUser = null;
        let currentExcelData = null;
        let originalExcelStructure = null;
        let currentExcelFile = null;
        let selectedOrientation = 'horizontal';
        
        const EXCEL_FILENAME = 'Limpieza_igle.xlsx';
        
        // Credenciales de usuario (se cargar√°n desde Excel)
        let VALID_USERS = {};

        let supervisorNames = {
            '1': '', '2': '', '3': '', '4': ''
        };
        let currentFontSize = 'md';
        let currentFontFamily = 'Arial';
        
        let scheduleData = {
            groups: [
                { name: 'Supervisoras grupo #1', color: '#ff6b9d', days: [] },
                { name: 'Supervisoras grupo #2', color: '#4ecdc4', days: [] },
                { name: 'Supervisoras grupo #3', color: '#95e1d3', days: [] },
                { name: 'Supervisoras grupo #4', color: '#ffd166', days: [] }
            ],
            startDate: null
        };

        // Variables para el sistema t√°ctil
        let touchDragging = false;
        let draggedPerson = null;
        let draggedPersonElement = null;
        let dragGhost = null;
        let startTouch = null;
        
        // Variables para movimiento de d√≠as
        let dayMoveMode = false;
        let sourceDayForMove = null;

        // Variables para control de posici√≥n
        let positionMoveMode = false;
        let personForPositionMove = null;
        let targetDayForPosition = null;
        let selectedPosition = 0;

        // Funci√≥n para verificar si un d√≠a tiene solo nombres "Vacio"
        function hasOnlyVacioNames(dayData) {
            return dayData.people.length > 0 && 
                   dayData.people.every(person => 
                       person.toLowerCase().includes('vacio') || 
                       person.trim() === 'Vacio'
                   );
        }

        // Funci√≥n para ocultar autom√°ticamente d√≠as con solo "Vacio"
        function autoHideVacioDays() {
            if (!isLoggedIn) return;
            
            let hiddenCount = 0;
            scheduleData.groups.forEach(group => {
                group.days.forEach(day => {
                    if (hasOnlyVacioNames(day) && !day.hidden) {
                        day.hidden = true;
                        hiddenCount++;
                    }
                });
            });
            
            if (hiddenCount > 0) {
                initSchedule();
                showStatus(`${hiddenCount} d√≠as con "Vacio" ocultados autom√°ticamente`);
            }
        }

        // Funci√≥n para procesar usuarios desde Excel
        function processUsersFromExcel(workbook) {
            VALID_USERS = {};
            
            const userSheetName = workbook.SheetNames.find(name => 
                name.toLowerCase() === 'usuario'
            );

            if (userSheetName) {
                const sheet = workbook.Sheets[userSheetName];
                const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (data.length > 0) {
                    for (let i = 0; i < data.length; i++) {
                        const row = data[i];
                        if (row && row[0]) {
                            const userData = row[0].toString().trim();
                            const parts = userData.split(/\s+/);
                            
                            if (parts.length >= 2) {
                                const username = parts[0].trim();
                                const password = parts[1].trim();
                                
                                if (username && password) {
                                    VALID_USERS[username] = password;
                                }
                            } else if (parts.length === 1) {
                                const username = parts[0].trim();
                                if (username) {
                                    VALID_USERS[username] = "k123k";
                                }
                            }
                        }
                    }
                }
            }
        }

        // Cargar Excel autom√°ticamente
        async function loadExcelAutomatically() {
            try {
                showStatus('Buscando archivo Excel...');
                
                const dragInfo = document.getElementById('dragInfo');
                dragInfo.textContent = 'Buscando ' + EXCEL_FILENAME + '...';
                
                try {
                    const response = await fetch(EXCEL_FILENAME);
                    
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        currentExcelData = workbook;
                        currentExcelFile = EXCEL_FILENAME;
                        
                        originalExcelStructure = {};
                        workbook.SheetNames.forEach(sheetName => {
                            originalExcelStructure[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                        });
                        
                        processUsersFromExcel(workbook);
                        processExcelData(workbook);
                        showStatus('Base de datos cargada correctamente desde ' + EXCEL_FILENAME);
                        return;
                    }
                } catch (error) {
                    console.log('No se pudo cargar desde servidor local:', error);
                }
                
                try {
                    const githubUrl = window.location.origin + '/' + EXCEL_FILENAME;
                    const response = await fetch(githubUrl);
                    
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        currentExcelData = workbook;
                        currentExcelFile = EXCEL_FILENAME;
                        
                        originalExcelStructure = {};
                        workbook.SheetNames.forEach(sheetName => {
                            originalExcelStructure[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                        });
                        
                        processUsersFromExcel(workbook);
                        processExcelData(workbook);
                        showStatus('Base de datos cargada correctamente desde GitHub');
                        return;
                    }
                } catch (error) {
                    console.log('No se pudo cargar desde GitHub:', error);
                }
                
                dragInfo.textContent = 'No se encontr√≥ ' + EXCEL_FILENAME + ' autom√°ticamente. Use el bot√≥n de carga manual.';
                document.getElementById('fileUploadSection').style.display = 'block';
                
            } catch (error) {
                console.log('Error en carga autom√°tica:', error);
                const dragInfo = document.getElementById('dragInfo');
                dragInfo.textContent = 'Error al buscar ' + EXCEL_FILENAME + '. Use el bot√≥n de carga manual.';
                document.getElementById('fileUploadSection').style.display = 'block';
            }
        }

        // Cargar Excel manualmente
        function loadExcelManually(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        currentExcelData = workbook;
                        currentExcelFile = file.name;
                        
                        originalExcelStructure = {};
                        workbook.SheetNames.forEach(sheetName => {
                            originalExcelStructure[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                        });
                        
                        processUsersFromExcel(workbook);
                        processExcelData(workbook);
                        showStatus('Archivo Excel cargado correctamente');
                        document.getElementById('fileUploadSection').style.display = 'none';
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Error al leer el archivo'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // Mostrar mensaje de estado
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 4000);
        }

        // Aplicar tama√±o de fuente y familia
        function applyFontStyles() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.className = `calendar-grid font-${currentFontSize}`;
            calendarGrid.style.fontFamily = currentFontFamily;
            
            document.querySelectorAll('.person-item, .day-header').forEach(el => {
                el.style.fontFamily = currentFontFamily;
            });
        }

        // Procesar nombres de supervisoras
        function processSupervisorNames() {
            supervisorNames = {'1': '', '2': '', '3': '', '4': ''};
            
            if (persons.length > 0) {
                persons.forEach(person => {
                    if (person.supervisor && person.supervisor.trim() !== '') {
                        const supervisorNum = person.supervisor.trim();
                        if (supervisorNames.hasOwnProperty(supervisorNum)) {
                            if (supervisorNames[supervisorNum] === '') {
                                supervisorNames[supervisorNum] = person.name;
                            } else {
                                supervisorNames[supervisorNum] += ' - ' + person.name;
                            }
                        }
                    }
                });
            }
            
            scheduleData.groups[0].name = `Supervisoras grupo #1 ${supervisorNames['1'] || ''}`;
            scheduleData.groups[1].name = `Supervisoras grupo #2 ${supervisorNames['2'] || ''}`;
            scheduleData.groups[2].name = `Supervisoras grupo #3 ${supervisorNames['3'] || ''}`;
            scheduleData.groups[3].name = `Supervisoras grupo #4 ${supervisorNames['4'] || ''}`;
        }

        // Procesar datos del Excel
        function processExcelData(workbook) {
            try {
                const scheduleSheetName = workbook.SheetNames.find(name => 
                    name.toLowerCase().includes('cronograma') || 
                    name.toLowerCase().includes('limpieza') ||
                    name.toLowerCase().includes('personas')
                ) || workbook.SheetNames[0];

                if (scheduleSheetName) {
                    const scheduleSheet = workbook.Sheets[scheduleSheetName];
                    const scheduleDataRaw = XLSX.utils.sheet_to_json(scheduleSheet, { header: 1 });
                    
                    persons = [];
                    
                    let nameCol = -1;
                    let supervisorCol = -1;
                    let statusCol = -1;
                    
                    if (scheduleDataRaw.length > 0) {
                        const headerRow = scheduleDataRaw[0];
                        
                        for (let i = 0; i < headerRow.length; i++) {
                            const cell = headerRow[i] ? headerRow[i].toString().toLowerCase() : '';
                            if (cell.includes('nombre') || cell.includes('persona')) nameCol = i;
                            if (cell.includes('supervisora')) supervisorCol = i;
                            if (cell.includes('estado')) statusCol = i;
                        }
                        
                        for (let i = 1; i < scheduleDataRaw.length; i++) {
                            const row = scheduleDataRaw[i];
                            if (row && row[nameCol] && row[nameCol].toString().trim() !== '') {
                                const name = row[nameCol].toString().trim();
                                const supervisor = supervisorCol !== -1 && row[supervisorCol] ? row[supervisorCol].toString().trim() : '';
                                const status = statusCol !== -1 && row[statusCol] ? row[statusCol].toString().trim() : '';
                                
                                persons.push({ 
                                    name: name, 
                                    supervisor: supervisor,
                                    status: status
                                });
                            }
                        }
                    }
                }

                processSupervisorNames();

                if (!scheduleData.startDate) {
                    scheduleData.startDate = new Date('2025-11-03');
                }
                
                updateDateInput();
                initialize6x4Structure();
                
                autoHideVacioDays();
                
                updateMonthYear();
                initSchedule();
                
            } catch (error) {
                console.error('Error procesando Excel:', error);
                showStatus('Error al procesar el Excel: ' + error.message, 'error');
            }
        }

        // Inicializar estructura
        function initialize6x4Structure() {
            const targetDays = [1, 3, 4, 5, 6, 0];
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            
            scheduleData.groups.forEach((group, groupIndex) => {
                group.days = [];
                
                let currentDate = new Date(scheduleData.startDate);
                currentDate.setDate(currentDate.getDate() + (groupIndex * 7));
                
                while (currentDate.getDay() !== 1) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                for (let i = 0; i < 6; i++) {
                    while (!targetDays.includes(currentDate.getDay())) {
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    const dayName = dayNames[currentDate.getDay()];
                    const dayNumber = currentDate.getDate();
                    const month = currentDate.getMonth() + 1;
                    const year = currentDate.getFullYear();
                    
                    const dateString = `${dayName} ${dayNumber}/${month}/${year}`;
                    
                    const people = [];
                    if (persons.length > 0) {
                        const startIndex = (groupIndex * 12 + i * 2) % persons.length;
                        for (let j = 0; j < 2; j++) {
                            const personIndex = (startIndex + j) % persons.length;
                            if (persons[personIndex] && persons[personIndex].name.trim() !== '') {
                                people.push(persons[personIndex].name);
                            }
                        }
                    }
                    
                    const hasOnlyVacio = people.length > 0 && 
                                        people.every(person => 
                                            person.toLowerCase().includes('vacio') || 
                                            person.trim() === 'Vacio'
                                        );
                    
                    group.days.push({
                        day: dateString,
                        people: people,
                        date: new Date(currentDate),
                        originalDate: new Date(currentDate),
                        isEmpty: people.length === 0,
                        hidden: hasOnlyVacio
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });
        }

        // Obtener el siguiente cuadro
        function getNextDay(groupIdx, dayIdx) {
            const group = scheduleData.groups[groupIdx];
            
            if (dayIdx < group.days.length - 1) {
                return { groupIdx: groupIdx, dayIdx: dayIdx + 1 };
            }
            
            if (groupIdx < scheduleData.groups.length - 1) {
                return { groupIdx: groupIdx + 1, dayIdx: 0 };
            }
            
            return { groupIdx: 0, dayIdx: 0 };
        }

        // Obtener el cuadro anterior
        function getPreviousDay(groupIdx, dayIdx) {
            const group = scheduleData.groups[groupIdx];
            
            if (dayIdx > 0) {
                return { groupIdx: groupIdx, dayIdx: dayIdx - 1 };
            }
            
            if (groupIdx > 0) {
                const prevGroup = scheduleData.groups[groupIdx - 1];
                return { groupIdx: groupIdx - 1, dayIdx: prevGroup.days.length - 1 };
            }
            
            const lastGroup = scheduleData.groups[scheduleData.groups.length - 1];
            return { groupIdx: scheduleData.groups.length - 1, dayIdx: lastGroup.days.length - 1 };
        }

        // Mover nombres hacia la derecha
        function shiftNamesRight(startGroupIdx, startDayIdx) {
            let currentGroupIdx = startGroupIdx;
            let currentDayIdx = startDayIdx;
            let movedPerson = null;
            
            let searchGroupIdx = startGroupIdx;
            let searchDayIdx = startDayIdx;
            
            while (true) {
                const nextDay = getNextDay(searchGroupIdx, searchDayIdx);
                
                if (nextDay.groupIdx === startGroupIdx && nextDay.dayIdx === startDayIdx) {
                    break;
                }
                
                const nextDayData = scheduleData.groups[nextDay.groupIdx].days[nextDay.dayIdx];
                if (nextDayData.people.length > 0) {
                    movedPerson = nextDayData.people.shift();
                    break;
                }
                
                searchGroupIdx = nextDay.groupIdx;
                searchDayIdx = nextDay.dayIdx;
            }
            
            if (movedPerson) {
                const startDay = scheduleData.groups[startGroupIdx].days[startDayIdx];
                startDay.people.push(movedPerson);
                startDay.isEmpty = false;
            }
            
            initSchedule();
            showStatus(movedPerson ? 'Persona agregada - Nombres movidos hacia la derecha' : 'No hay personas disponibles para mover');
        }

        // Mover nombres hacia la izquierda
        function shiftNamesLeft(startGroupIdx, startDayIdx) {
            const startDay = scheduleData.groups[startGroupIdx].days[startDayIdx];
            
            if (startDay.people.length === 0) {
                showStatus('No hay personas para quitar en este cuadro', 'error');
                return;
            }
            
            const removedPerson = startDay.people.pop();
            startDay.isEmpty = startDay.people.length === 0;
            
            let currentGroupIdx = startGroupIdx;
            let currentDayIdx = startDayIdx;
            let placed = false;
            
            while (!placed) {
                const nextDay = getNextDay(currentGroupIdx, currentDayIdx);
                
                const nextDayData = scheduleData.groups[nextDay.groupIdx].days[nextDay.dayIdx];
                if (nextDayData.people.length < 4) {
                    nextDayData.people.unshift(removedPerson);
                    nextDayData.isEmpty = false;
                    placed = true;
                    break;
                }
                
                currentGroupIdx = nextDay.groupIdx;
                currentDayIdx = nextDay.dayIdx;
                
                if (currentGroupIdx === startGroupIdx && currentDayIdx === startDayIdx) {
                    showStatus('No hay espacio disponible en otros cuadros', 'error');
                    return;
                }
            }
            
            initSchedule();
            showStatus(`Persona "${removedPerson}" movida a otro cuadro`);
        }

        // Agregar persona
        function addPerson(groupIdx, dayIdx) {
            const dayData = scheduleData.groups[groupIdx].days[dayIdx];
            
            if (dayData.people.length >= 4) {
                showStatus('M√°ximo 4 personas por d√≠a', 'error');
                return;
            }
            
            shiftNamesRight(groupIdx, dayIdx);
        }

        // Quitar persona
        function removePerson(groupIdx, dayIdx) {
            shiftNamesLeft(groupIdx, dayIdx);
        }

        // Alternar visibilidad del d√≠a
        function toggleDayVisibility(groupIdx, dayIdx) {
            if (!isLoggedIn) {
                showStatus('Debe iniciar sesi√≥n para ocultar/mostrar d√≠as', 'error');
                return;
            }
            
            const dayData = scheduleData.groups[groupIdx].days[dayIdx];
            dayData.hidden = !dayData.hidden;
            
            initSchedule();
            showStatus(`D√≠a ${dayData.hidden ? 'oculto' : 'mostrado'} correctamente`);
        }

        // SISTEMA DE CONTROL DE POSICI√ìN
        function startPositionMove(personElement) {
            const groupIdx = parseInt(personElement.closest('.calendar-day').dataset.group);
            const dayIdx = parseInt(personElement.closest('.calendar-day').dataset.day);
            const personIndex = Array.from(personElement.parentNode.children).indexOf(personElement);
            
            personForPositionMove = {
                sourceGroup: groupIdx,
                sourceDay: dayIdx,
                personIndex: personIndex,
                personName: personElement.textContent
            };
            
            // Mostrar modal de selecci√≥n de posici√≥n
            showPositionModal();
        }

        function showPositionModal() {
            const modal = document.getElementById('positionIndicatorModal');
            modal.classList.add('active');
            
            // Resetear selecci√≥n
            selectedPosition = 0;
            document.querySelectorAll('.position-option').forEach(option => {
                option.classList.remove('selected');
                if (parseInt(option.dataset.position) === selectedPosition) {
                    option.classList.add('selected');
                }
            });
        }

        function hidePositionModal() {
            const modal = document.getElementById('positionIndicatorModal');
            modal.classList.remove('active');
        }

        function movePersonWithPosition(targetGroupIdx, targetDayIdx, position) {
            if (!personForPositionMove) return;
            
            const sourceDay = scheduleData.groups[personForPositionMove.sourceGroup].days[personForPositionMove.sourceDay];
            const targetDay = scheduleData.groups[targetGroupIdx].days[targetDayIdx];
            
            if (targetDay.people.length >= 4) {
                showStatus('No se puede mover: d√≠a destino ya tiene 4 personas', 'error');
                return;
            }
            
            const movedPerson = sourceDay.people.splice(personForPositionMove.personIndex, 1)[0];
            
            // Insertar en la posici√≥n especificada
            if (position === 0) {
                // Arriba del todo
                targetDay.people.unshift(movedPerson);
            } else if (position === 2) {
                // Abajo del todo
                targetDay.people.push(movedPerson);
            } else {
                // En medio (posici√≥n 1)
                const middleIndex = Math.floor(targetDay.people.length / 2);
                targetDay.people.splice(middleIndex, 0, movedPerson);
            }
            
            sourceDay.isEmpty = sourceDay.people.length === 0;
            targetDay.isEmpty = false;
            
            initSchedule();
            showStatus(`Persona "${movedPerson}" movida a posici√≥n ${getPositionName(position)}`);
            
            personForPositionMove = null;
        }

        function getPositionName(position) {
            switch(position) {
                case 0: return 'arriba del todo';
                case 1: return 'en el medio';
                case 2: return 'abajo del todo';
                default: return 'posici√≥n especificada';
            }
        }

        // SISTEMA T√ÅCTIL MEJORADO PARA PERSONAS
        function initializeTouchSystem() {
            // Eventos para personas
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
            document.addEventListener('touchcancel', handleTouchEnd);
        }

        function handleTouchStart(e) {
            if (!isLoggedIn || dayMoveMode) return;
            
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (target && target.classList.contains('person-item')) {
                e.preventDefault();
                startTouch = {
                    x: touch.clientX,
                    y: touch.clientY,
                    target: target,
                    time: Date.now()
                };
            }
        }

        function handleTouchMove(e) {
            if (!startTouch || dayMoveMode) return;
            
            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - startTouch.x);
            const deltaY = Math.abs(touch.clientY - startTouch.y);
            
            // Iniciar arrastre despu√©s de un movimiento m√≠nimo
            if ((deltaX > 10 || deltaY > 10) && !touchDragging) {
                startDrag(startTouch.target, touch);
                touchDragging = true;
            }
            
            if (touchDragging && draggedPersonElement) {
                e.preventDefault();
                updateDragPosition(touch);
                updateDropTargets(touch);
            }
        }

        function handleTouchEnd(e) {
            if (touchDragging) {
                const touch = e.changedTouches[0];
                completeDrag(touch);
            } else if (startTouch) {
                // Fue un tap, mostrar opciones de posici√≥n
                const duration = Date.now() - startTouch.time;
                if (duration < 500) { // Tap corto
                    showPersonOptions(startTouch.target, e.changedTouches[0]);
                }
            }
            resetDrag();
        }

        function showPersonOptions(personElement, touch) {
            const groupIdx = parseInt(personElement.closest('.calendar-day').dataset.group);
            const dayIdx = parseInt(personElement.closest('.calendar-day').dataset.day);
            const personIndex = Array.from(personElement.parentNode.children).indexOf(personElement);
            
            const menu = document.createElement('div');
            menu.className = 'mobile-menu';
            menu.style.left = Math.min(touch.clientX, window.innerWidth - 200) + 'px';
            menu.style.top = Math.min(touch.clientY, window.innerHeight - 250) + 'px';
            
            menu.innerHTML = `
                <div style="margin-bottom: 8px; font-weight: bold; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                    ${personElement.textContent}
                </div>
                <button class="mobile-menu-btn" data-action="moveWithPosition">üéØ Mover con posici√≥n</button>
                <button class="mobile-menu-btn" data-action="removePerson">üóëÔ∏è Eliminar</button>
                <button class="mobile-menu-btn cancel" data-action="cancel">‚ùå Cancelar</button>
            `;
            
            document.body.appendChild(menu);
            
            // Event listeners
            menu.querySelectorAll('.mobile-menu-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = this.dataset.action;
                    
                    switch(action) {
                        case 'moveWithPosition':
                            startPositionMoveWithTarget(personElement);
                            break;
                        case 'removePerson':
                            removeSpecificPerson(groupIdx, dayIdx, personIndex);
                            break;
                    }
                    
                    document.body.removeChild(menu);
                });
            });
            
            // Cerrar men√∫ al tocar fuera
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        document.body.removeChild(menu);
                        document.removeEventListener('touchstart', closeMenu);
                    }
                };
                document.addEventListener('touchstart', closeMenu);
            }, 100);
        }

        function startPositionMoveWithTarget(personElement) {
            const groupIdx = parseInt(personElement.closest('.calendar-day').dataset.group);
            const dayIdx = parseInt(personElement.closest('.calendar-day').dataset.day);
            const personIndex = Array.from(personElement.parentNode.children).indexOf(personElement);
            
            personForPositionMove = {
                sourceGroup: groupIdx,
                sourceDay: dayIdx,
                personIndex: personIndex,
                personName: personElement.textContent
            };
            
            positionMoveMode = true;
            showStatus('Seleccione el d√≠a destino para mover con posici√≥n');
            
            // Resaltar d√≠as destino posibles
            document.querySelectorAll('.calendar-day').forEach(day => {
                const targetGroupIdx = parseInt(day.dataset.group);
                const targetDayIdx = parseInt(day.dataset.day);
                const targetDay = scheduleData.groups[targetGroupIdx].days[targetDayIdx];
                
                if (!(groupIdx === targetGroupIdx && dayIdx === targetDayIdx) &&
                    !day.classList.contains('hidden') && !day.classList.contains('empty') &&
                    targetDay.people.length < 4) {
                    day.classList.add('drop-target');
                    day.addEventListener('click', handlePositionTargetSelection);
                }
            });
        }

        function handlePositionTargetSelection(e) {
            if (!positionMoveMode || !personForPositionMove) return;
            
            const targetElement = e.currentTarget;
            const targetGroupIdx = parseInt(targetElement.dataset.group);
            const targetDayIdx = parseInt(targetElement.dataset.day);
            
            targetDayForPosition = { groupIdx: targetGroupIdx, dayIdx: targetDayIdx };
            showPositionModal();
            
            // Limpiar estilos y eventos
            cleanupPositionMoveMode();
        }

        function cleanupPositionMoveMode() {
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('drop-target');
                day.removeEventListener('click', handlePositionTargetSelection);
            });
            positionMoveMode = false;
        }

        function removeSpecificPerson(groupIdx, dayIdx, personIndex) {
            const dayData = scheduleData.groups[groupIdx].days[dayIdx];
            const removedPerson = dayData.people.splice(personIndex, 1)[0];
            dayData.isEmpty = dayData.people.length === 0;
            
            initSchedule();
            showStatus(`Persona "${removedPerson}" eliminada`);
        }

        // ... (el resto del c√≥digo de las funciones de drag & drop se mantiene igual)

        // Inicializar el cronograma con botones de posici√≥n
        function initSchedule() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            if (scheduleData.groups[0].days.length === 0) {
                const dragInfo = document.createElement('div');
                dragInfo.className = 'drag-info';
                dragInfo.textContent = 'No hay datos disponibles. Cargue un archivo Excel.';
                grid.appendChild(dragInfo);
                return;
            }

            scheduleData.groups.forEach((group, groupIdx) => {
                const groupHeader = document.createElement('div');
                groupHeader.className = 'group-header';
                groupHeader.textContent = group.name;
                groupHeader.style.background = group.color;
                grid.appendChild(groupHeader);

                group.days.forEach((dayData, dayIdx) => {
                    if (hasOnlyVacioNames(dayData) && !dayData.hidden && isLoggedIn) {
                        dayData.hidden = true;
                    }
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = `calendar-day ${dayData.isEmpty ? 'empty' : ''} ${dayData.hidden ? 'hidden' : ''}`;
                    dayDiv.dataset.group = groupIdx;
                    dayDiv.dataset.day = dayIdx;
                    
                    if (dayData.day.toLowerCase().includes('domingo')) {
                        dayDiv.classList.add('sunday');
                    }

                    const header = document.createElement('div');
                    header.className = 'day-header';
                    header.textContent = dayData.day;

                    const content = document.createElement('div');
                    content.className = 'day-content';
                    
                    // Controles de posici√≥n (solo si est√° logueado y no est√° vac√≠o/oculto)
                    if (isLoggedIn && !dayData.hidden && !dayData.isEmpty) {
                        const positionControls = document.createElement('div');
                        positionControls.className = 'position-controls';
                        
                        const upBtn = document.createElement('button');
                        upBtn.className = 'position-btn up';
                        upBtn.innerHTML = '‚¨ÜÔ∏è';
                        upBtn.title = 'Mover persona con posici√≥n espec√≠fica';
                        upBtn.onclick = (e) => {
                            e.stopPropagation();
                            showPositionMoveMenu(dayDiv);
                        };
                        positionControls.appendChild(upBtn);
                        
                        const downBtn = document.createElement('button');
                        downBtn.className = 'position-btn down';
                        downBtn.innerHTML = '‚¨áÔ∏è';
                        downBtn.title = 'Mover persona con posici√≥n espec√≠fica';
                        downBtn.onclick = (e) => {
                            e.stopPropagation();
                            showPositionMoveMenu(dayDiv);
                        };
                        positionControls.appendChild(downBtn);
                        
                        dayDiv.appendChild(positionControls);
                    }

                    if (dayData.hidden) {
                        const noActivityDiv = document.createElement('div');
                        noActivityDiv.className = 'no-activity';
                        noActivityDiv.textContent = 'Sin actividad';
                        content.appendChild(noActivityDiv);
                    } else if (dayData.isEmpty) {
                        const noActivityDiv = document.createElement('div');
                        noActivityDiv.className = 'no-activity';
                        noActivityDiv.textContent = 'Sin actividad';
                        content.appendChild(noActivityDiv);
                    } else {
                        const personList = document.createElement('div');
                        personList.className = 'person-list';
                        
                        if (dayData.people.length === 4) {
                            const morningLabel = document.createElement('div');
                            morningLabel.className = 'time-label';
                            morningLabel.textContent = 'por la ma√±ana';
                            personList.appendChild(morningLabel);
                            
                            dayData.people.slice(0, 2).forEach((person, index) => {
                                const personDiv = createPersonElement(person, groupIdx, dayIdx, index);
                                personList.appendChild(personDiv);
                            });
                            
                            const afternoonLabel = document.createElement('div');
                            afternoonLabel.className = 'time-label';
                            afternoonLabel.textContent = 'por la tarde';
                            personList.appendChild(afternoonLabel);
                            
                            dayData.people.slice(2, 4).forEach((person, index) => {
                                const personDiv = createPersonElement(person, groupIdx, dayIdx, index + 2);
                                personList.appendChild(personDiv);
                            });
                        } else {
                            dayData.people.forEach((person, index) => {
                                const personDiv = createPersonElement(person, groupIdx, dayIdx, index);
                                personList.appendChild(personDiv);
                            });
                        }
                        
                        content.appendChild(personList);
                    }

                    if (dayData.people.length > 0 && !dayData.hidden) {
                        const countDiv = document.createElement('div');
                        countDiv.className = 'person-count';
                        countDiv.textContent = dayData.people.length;
                        dayDiv.appendChild(countDiv);
                    }

                    const actionButtons = document.createElement('div');
                    actionButtons.className = 'day-actions';
                    
                    if (isLoggedIn) {
                        const addBtn = document.createElement('button');
                        addBtn.className = 'action-btn add-btn';
                        addBtn.innerHTML = '+';
                        addBtn.title = 'Agregar persona';
                        addBtn.onclick = (e) => {
                            e.stopPropagation();
                            addPerson(groupIdx, dayIdx);
                        };
                        actionButtons.appendChild(addBtn);
                    }
                    
                    if (isLoggedIn) {
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'action-btn remove-btn';
                        removeBtn.innerHTML = '-';
                        removeBtn.title = 'Quitar √∫ltima persona';
                        removeBtn.onclick = (e) => {
                            e.stopPropagation();
                            removePerson(groupIdx, dayIdx);
                        };
                        actionButtons.appendChild(removeBtn);
                    }
                    
                    if (isLoggedIn) {
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'action-btn toggle-btn';
                        toggleBtn.innerHTML = dayData.hidden ? 'üëÅÔ∏è' : 'üëÅÔ∏è';
                        toggleBtn.title = dayData.hidden ? 'Mostrar d√≠a' : 'Ocultar d√≠a';
                        toggleBtn.onclick = (e) => {
                            e.stopPropagation();
                            toggleDayVisibility(groupIdx, dayIdx);
                        };
                        actionButtons.appendChild(toggleBtn);
                    }

                    dayDiv.appendChild(actionButtons);
                    dayDiv.appendChild(header);
                    dayDiv.appendChild(content);
                    grid.appendChild(dayDiv);
                });
            });

            applyFontStyles();
        }

        function createPersonElement(person, groupIdx, dayIdx, index) {
            const personDiv = document.createElement('div');
            personDiv.className = 'person-item';
            personDiv.textContent = person;
            personDiv.dataset.group = groupIdx;
            personDiv.dataset.day = dayIdx;
            personDiv.dataset.index = index;
            
            if (isLoggedIn) {
                personDiv.addEventListener('click', function(e) {
                    if (e.ctrlKey || e.metaKey) {
                        // Ctrl+click para mover con posici√≥n
                        startPositionMove(this);
                    }
                });
                
                // Doble click para mover con posici√≥n
                let clickTimer = null;
                personDiv.addEventListener('click', function(e) {
                    if (clickTimer === null) {
                        clickTimer = setTimeout(() => {
                            clickTimer = null;
                        }, 300);
                    } else {
                        clearTimeout(clickTimer);
                        clickTimer = null;
                        startPositionMove(this);
                    }
                });
            }
            
            return personDiv;
        }

        function showPositionMoveMenu(dayElement) {
            const groupIdx = parseInt(dayElement.dataset.group);
            const dayIdx = parseInt(dayElement.dataset.day);
            
            targetDayForPosition = { groupIdx: groupIdx, dayIdx: dayIdx };
            showStatus('Seleccione la persona a mover');
            
            // Resaltar personas en el d√≠a actual
            dayElement.querySelectorAll('.person-item').forEach(person => {
                person.style.background = '#e3f2fd';
                person.style.border = '2px solid #00b4db';
                person.addEventListener('click', handlePersonSelectionForPosition);
            });
        }

        function handlePersonSelectionForPosition(e) {
            e.stopPropagation();
            const personElement = e.currentTarget;
            const groupIdx = parseInt(personElement.dataset.group);
            const dayIdx = parseInt(personElement.dataset.day);
            const personIndex = parseInt(personElement.dataset.index);
            
            personForPositionMove = {
                sourceGroup: groupIdx,
                sourceDay: dayIdx,
                personIndex: personIndex,
                personName: personElement.textContent
            };
            
            // Limpiar estilos
            document.querySelectorAll('.person-item').forEach(p => {
                p.style.background = '';
                p.style.border = '';
                p.removeEventListener('click', handlePersonSelectionForPosition);
            });
            
            showPositionModal();
        }

        // Event listeners para el modal de posici√≥n
        document.getElementById('confirmPositionBtn').addEventListener('click', function() {
            if (personForPositionMove && targetDayForPosition) {
                movePersonWithPosition(
                    targetDayForPosition.groupIdx,
                    targetDayForPosition.dayIdx,
                    selectedPosition
                );
            }
            hidePositionModal();
        });

        document.getElementById('cancelPositionBtn').addEventListener('click', function() {
            hidePositionModal();
            personForPositionMove = null;
            targetDayForPosition = null;
        });

        document.querySelectorAll('.position-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.position-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                selectedPosition = parseInt(this.dataset.position);
            });
        });

        // ... (el resto del c√≥digo se mantiene igual)

        // Inicializar sistemas t√°ctiles
        initializeTouchSystem();
        initializeDayTouchSystem();
        
        // Inicializar aplicaci√≥n
        loadExcelAutomatically();
    </script>
</body>
</html>
